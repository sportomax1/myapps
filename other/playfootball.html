<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Master: Pro Edition</title>
    <style>
        :root {
            --nfl-blue: #013369;
            --nfl-red: #d50a0a;
            --gold: #ffcc00;
            --field-green: #2d5a27;
        }
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; background: #000; color: white; touch-action: none; }

        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; pointer-events: all;
        }
        .hidden { display: none !important; }

        /* HUD */
        #hud {
            position: absolute; top: 10px; width: 100%; display: flex; 
            justify-content: center; gap: 10px; pointer-events: none;
        }
        .hud-box {
            background: rgba(0,0,0,0.9); border-bottom: 3px solid var(--nfl-blue);
            padding: 5px 15px; border-radius: 5px; text-align: center;
        }
        .hud-val { font-size: 20px; font-weight: 900; color: white; }
        .hud-lab { font-size: 10px; color: #aaa; text-transform: uppercase; }

        /* Announcer */
        #announcer {
            position: absolute; top: 40%; width: 100%; text-align: center;
            font-size: 4rem; font-weight: 900; color: var(--gold);
            text-shadow: 0 0 20px black; opacity: 0; transition: 0.3s;
        }
        #announcer.show { opacity: 1; transform: scale(1.1); }

        /* Controls / Touch UI */
        .touch-btn {
            position: absolute; pointer-events: all; background: rgba(255,255,255,0.2);
            border: 2px solid white; border-radius: 50%; width: 70px; height: 70px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 24px; color: white; backdrop-filter: blur(5px);
        }
        .touch-btn:active { background: var(--gold); color: black; transform: scale(0.9); }

        #snap-btn { bottom: 40px; right: 40px; width: 100px; height: 100px; background: var(--nfl-blue); border-color: var(--gold); }
        
        #pass-controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .pass-btn { position: relative; width: 60px; height: 60px; font-size: 18px; }

        #joystick-container { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: all; }
        #joystick-knob { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: white; border-radius: 50%; transition: transform 0.1s; }

        h1 { font-size: 3rem; margin: 0; color: white; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-start { background: var(--gold); color: black; padding: 15px 40px; border-radius: 50px; font-weight: 900; border: none; cursor: pointer; margin-top: 20px; font-size: 1.2rem; }

        canvas { display: block; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="screen-welcome" class="screen">
            <h1>FOOTBALL MASTER</h1>
            <p>TOUCH TO LEAD YOUR TEAM</p>
            <button class="btn-start" onclick="startGame()">START GAME</button>
        </div>

        <div id="game-ui" class="hidden">
            <div id="hud">
                <div class="hud-box"><div class="hud-lab">Score</div><div id="score" class="hud-val">0</div></div>
                <div class="hud-box"><div class="hud-lab">Down</div><div id="down" class="hud-val">1ST & 10</div></div>
                <div class="hud-box"><div class="hud-lab">Yard</div><div id="yard" class="hud-val">20</div></div>
            </div>

            <div id="announcer">TOUCHDOWN!</div>

            <!-- Pre-snap Instruction -->
            <div id="pre-snap-hint" style="position: absolute; top: 120px; width: 100%; text-align: center; font-weight: bold; color: var(--gold);">
                REVIEW ROUTES... TAP SNAP TO BEGIN
            </div>

            <!-- Joystick (Mobile) -->
            <div id="joystick-container"><div id="joystick-knob"></div></div>

            <!-- Snap Button -->
            <div id="snap-btn" class="touch-btn" onclick="snapBall()">SNAP</div>

            <!-- Pass Buttons -->
            <div id="pass-controls" class="hidden">
                <div class="touch-btn pass-btn" onclick="passTo(0)" style="border-color: #00ff00;">X</div>
                <div class="touch-btn pass-btn" onclick="passTo(1)" style="border-color: #00ffff;">Y</div>
                <div class="touch-btn pass-btn" onclick="passTo(2)" style="border-color: #ff00ff;">Z</div>
            </div>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- Constants ---
        const Y_UNIT = 1.2;
        const FIELD_WIDTH = 53.3 * Y_UNIT;
        const STATE = { PRE_SNAP: 0, ACTIVE: 1, BALL_IN_AIR: 2, RESULT: 3 };

        // --- Game Variables ---
        let scene, camera, renderer, clock;
        let qb, ball, ballShadow;
        let receivers = [], defenders = [], routeLines = [];
        let gameState = STATE.PRE_SNAP;
        let score = 0;
        let moveInput = { x: 0, y: 0 };
        let ballVel = new THREE.Vector3();
        let targetRecIndex = -1;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            scene.fog = new THREE.Fog(0x87ceeb, 40, 160);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 1.2);
            sun.position.set(50, 100, 50);
            sun.castShadow = true;
            scene.add(sun);

            createField();
            createPlayers();
            createBall();
            setupInput();

            clock = new THREE.Clock();
            resetPlay();
            animate();
        }

        function createField() {
            const grass = new THREE.Mesh(new THREE.PlaneGeometry(FIELD_WIDTH, 120 * Y_UNIT), new THREE.MeshPhongMaterial({ color: 0x2e5e2e }));
            grass.rotation.x = -Math.PI/2;
            grass.receiveShadow = true;
            scene.add(grass);

            // Lines & Yard Markers
            for (let i = -50; i <= 50; i += 10) {
                const line = new THREE.Mesh(new THREE.PlaneGeometry(FIELD_WIDTH, 0.4), new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 }));
                line.rotation.x = -Math.PI/2;
                line.position.set(0, 0.01, i * Y_UNIT);
                scene.add(line);
            }
        }

        function createPlayers() {
            const createMan = (color) => {
                const g = new THREE.Group();
                const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshPhongMaterial({ color }));
                body.position.y = 1.2;
                g.add(body);
                const head = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshPhongMaterial({ color: 0xffdbac }));
                head.position.y = 2.0;
                g.add(head);
                const helmet = new THREE.Mesh(new THREE.SphereGeometry(0.38, 16, 16, 0, Math.PI*2, 0, Math.PI/1.5), new THREE.MeshPhongMaterial({ color: 0xffcc00 }));
                helmet.position.y = 2.0;
                g.add(helmet);
                g.castShadow = true;
                return g;
            };

            qb = createMan(0x222222);
            scene.add(qb);

            const routes = [
                { id: 'X', color: 0x00ff00, pts: [new THREE.Vector3(-15,0,0), new THREE.Vector3(-15,0,-15), new THREE.Vector3(-5,0,-25)] },
                { id: 'Y', color: 0x00ffff, pts: [new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-40)] },
                { id: 'Z', color: 0xff00ff, pts: [new THREE.Vector3(15,0,0), new THREE.Vector3(15,0,-15), new THREE.Vector3(25,0,-20)] }
            ];

            routes.forEach((r, i) => {
                const rec = createMan(0x2d5a27);
                rec.userData = { route: r.pts, color: r.color, index: i };
                receivers.push(rec);
                scene.add(rec);

                const def = createMan(0xd50a0a);
                defenders.push(def);
                scene.add(def);

                // Route Visualization Line
                const lineGeo = new THREE.BufferGeometry().setFromPoints(r.pts);
                const lineMat = new THREE.LineBasicMaterial({ color: r.color, transparent: true, opacity: 0.5, linewidth: 2 });
                const line = new THREE.Line(lineGeo, lineMat);
                routeLines.push(line);
                scene.add(line);
            });
        }

        function createBall() {
            ball = new THREE.Mesh(new THREE.SphereGeometry(0.25).scale(1.4,1,1), new THREE.MeshPhongMaterial({ color: 0x654321 }));
            scene.add(ball);
            ballShadow = new THREE.Mesh(new THREE.CircleGeometry(0.3), new THREE.MeshBasicMaterial({ color: 0, transparent: true, opacity: 0.4 }));
            ballShadow.rotation.x = -Math.PI/2;
            scene.add(ballShadow);
        }

        function resetPlay() {
            gameState = STATE.PRE_SNAP;
            qb.position.set(0, 0, 40 * Y_UNIT);
            qb.rotation.y = 0;
            
            receivers.forEach((rec, i) => {
                const startPos = rec.userData.route[0].clone().add(new THREE.Vector3(0, 0, 38 * Y_UNIT));
                rec.position.copy(startPos);
                defenders[i].position.copy(startPos).add(new THREE.Vector3(0, 0, -5));
                routeLines[i].position.copy(startPos);
                routeLines[i].visible = true;
            });

            ball.visible = true;
            ballShadow.visible = false;
            announce("", false);
            
            document.getElementById('snap-btn').classList.remove('hidden');
            document.getElementById('pass-controls').classList.add('hidden');
            document.getElementById('pre-snap-hint').classList.remove('hidden');
        }

        window.snapBall = () => {
            if (gameState !== STATE.PRE_SNAP) return;
            gameState = STATE.ACTIVE;
            routeLines.forEach(l => l.visible = false);
            document.getElementById('snap-btn').classList.add('hidden');
            document.getElementById('pass-controls').classList.remove('hidden');
            document.getElementById('pre-snap-hint').classList.add('hidden');
        };

        window.passTo = (index) => {
            if (gameState !== STATE.ACTIVE) return;
            gameState = STATE.BALL_IN_AIR;
            targetRecIndex = index;
            
            const target = receivers[index].position.clone().add(new THREE.Vector3(0, 1.5, -5)); // Lead the receiver
            const start = ball.position.clone();
            
            const dist = start.distanceTo(target);
            const travelTime = dist / 25;
            
            ballVel.copy(target).sub(start).divideScalar(travelTime);
            ballVel.y = 10; // Arc
            
            document.getElementById('pass-controls').classList.add('hidden');
        };

        function updateBall(delta) {
            if (gameState === STATE.ACTIVE) {
                ball.position.set(qb.position.x + 0.5, 2.2, qb.position.z - 0.2);
            } else if (gameState === STATE.BALL_IN_AIR) {
                ballShadow.visible = true;
                ballShadow.position.set(ball.position.x, 0.02, ball.position.z);
                
                ballVel.y -= 18 * delta; // Gravity
                ball.position.add(ballVel.clone().multiplyScalar(delta));
                ball.rotation.x += 10 * delta;

                // Catch logic
                const rec = receivers[targetRecIndex];
                if (ball.position.distanceTo(rec.position.clone().add(new THREE.Vector3(0,2,0))) < 1.5) {
                    score += 7;
                    document.getElementById('score').innerText = score;
                    finishPlay("TOUCHDOWN!", true);
                } else if (ball.position.y < 0.2) {
                    finishPlay("INCOMPLETE", false);
                }

                // Defensive Interception
                defenders.forEach(def => {
                    if (ball.position.distanceTo(def.position.clone().add(new THREE.Vector3(0,2,0))) < 1.2) {
                        finishPlay("INTERCEPTED!", false);
                    }
                });
            }
        }

        function finishPlay(msg, success) {
            gameState = STATE.RESULT;
            announce(msg, true);
            setTimeout(resetPlay, 2000);
        }

        function updatePlayers(delta) {
            if (gameState === STATE.ACTIVE || gameState === STATE.BALL_IN_AIR) {
                // QB Movement
                const speed = 10;
                qb.position.x += moveInput.x * speed * delta;
                qb.position.z += moveInput.y * speed * delta;
                if (Math.abs(moveInput.x) > 0.1 || Math.abs(moveInput.y) > 0.1) {
                    qb.rotation.y = Math.atan2(moveInput.x, moveInput.y);
                }

                // Receivers run routes
                receivers.forEach((rec, i) => {
                    const route = rec.userData.route;
                    const worldPts = route.map(p => p.clone().add(routeLines[i].position));
                    
                    // Simple logic: move towards next point in route
                    const target = worldPts[1]; // simplified to just 1st downfield point
                    const dir = target.clone().sub(rec.position).normalize();
                    rec.position.add(dir.multiplyScalar(8 * delta));
                    rec.lookAt(target);

                    // Defenders shadow
                    const def = defenders[i];
                    const defTarget = rec.position.clone().add(new THREE.Vector3(0,0,-2));
                    def.position.lerp(defTarget, 0.05);
                    def.lookAt(rec.position);
                });
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            updatePlayers(delta);
            updateBall(delta);
            
            // Camera
            const camTarget = (gameState === STATE.BALL_IN_AIR) ? ball.position : qb.position;
            camera.position.lerp(new THREE.Vector3(camTarget.x, 15, camTarget.z + 18), 0.1);
            camera.lookAt(camTarget);

            renderer.render(scene, camera);
        }

        function setupInput() {
            // Keyboard
            window.addEventListener('keydown', e => {
                if (e.code === 'ArrowUp' || e.code === 'KeyW') moveInput.y = -1;
                if (e.code === 'ArrowDown' || e.code === 'KeyS') moveInput.y = 1;
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') moveInput.x = -1;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') moveInput.x = 1;
                if (e.code === 'Space') snapBall();
                if (e.code === 'KeyX') passTo(0);
                if (e.code === 'KeyY') passTo(1);
                if (e.code === 'KeyZ') passTo(2);
            });
            window.addEventListener('keyup', e => { moveInput.x = 0; moveInput.y = 0; });

            // Simple Touch Joystick
            const joy = document.getElementById('joystick-container');
            const knob = document.getElementById('joystick-knob');
            joy.addEventListener('touchstart', (e) => { e.preventDefault(); }, {passive: false});
            joy.addEventListener('touchmove', (e) => {
                const rect = joy.getBoundingClientRect();
                const touch = e.touches[0];
                const x = (touch.clientX - rect.left - 60) / 60;
                const y = (touch.clientY - rect.top - 60) / 60;
                moveInput.x = Math.max(-1, Math.min(1, x));
                moveInput.y = Math.max(-1, Math.min(1, y));
                knob.style.transform = `translate(${moveInput.x * 30}px, ${moveInput.y * 30}px)`;
            });
            joy.addEventListener('touchend', () => { moveInput = {x:0, y:0}; knob.style.transform = ''; });
        }

        function announce(text, show) {
            const el = document.getElementById('announcer');
            el.innerText = text;
            el.className = show ? 'show' : '';
        }

        window.startGame = () => {
            document.getElementById('screen-welcome').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            resetPlay();
        };

        window.onResize = () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        };
        window.addEventListener('resize', onResize);

        init();
    </script>
</body>
</html>