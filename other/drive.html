<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Explorer v4</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --accent: #30d158;
            --bg: #000;
            --panel-bg: rgba(20, 20, 22, 0.98);
            --text: #fff;
            --info: #0a84ff;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); overflow: hidden; color: var(--text); }
        #map { height: 100vh; width: 100%; filter: brightness(0.6) contrast(1.1) saturate(0.8); }
        
        .control-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: var(--panel-bg); backdrop-filter: blur(30px);
            padding: 20px; border-radius: 28px; box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            width: 94%; max-width: 500px; display: flex; flex-direction: column; gap: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-label { font-size: 8px; text-transform: uppercase; color: #8e8e93; font-weight: 800; letter-spacing: 1px; margin-bottom: 2px; }
        .stat-value { font-size: 15px; font-weight: 800; font-variant-numeric: tabular-nums; }

        .log-container {
            background: #000; border-radius: 16px; padding: 12px;
            height: 140px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column-reverse; gap: 4px;
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        .log-entry { font-size: 11px; line-height: 1.4; color: #636366; }
        .log-entry.decision { color: var(--info); font-weight: bold; border-left: 2px solid var(--info); padding-left: 6px; }
        .log-entry.sys { color: var(--accent); }

        .btn {
            background: var(--accent); color: #000; border: none; padding: 18px;
            border-radius: 20px; font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.2s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-stop { background: #ff453a; color: white; }

        .loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay">
        <div style="font-size: 40px; margin-bottom: 10px;">üõ∞Ô∏è</div>
        <div style="font-weight: 700;">Acquiring GPS Signal...</div>
    </div>
    
    <div id="map"></div>

    <div class="control-panel" id="ui" style="display:none">
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Odometer</div>
                <div class="stat-value" id="odoVal">0.00 mi</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Compass</div>
                <div class="stat-value" id="dirVal">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Status</div>
                <div class="stat-value" id="statusVal" style="color:var(--info)">STANDBY</div>
            </div>
        </div>

        <div class="log-container" id="driveLog"></div>

        <button class="btn" id="driveBtn">Start Mission</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, carMarker, activePath, trail;
        let isDriving = false;
        let currentPos = null;
        let routeCoords = [];
        let currentManeuvers = [];
        let currentIndex = 0;
        let totalMiles = 0;
        let driveTimeout;
        let currentBearing = 0;

        // Init Map
        map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 17);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        const carIcon = L.divIcon({
            html: `<div id="car" style="font-size: 36px; transition: transform 0.15s linear;">üöó</div>`,
            className: 'car-icon', iconSize: [40, 40], iconAnchor: [20, 20]
        });

        function log(msg, type = "") {
            const el = document.getElementById('driveLog');
            const entry = document.createElement('div');
            entry.className = "log-entry " + type;
            const time = new Date().toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
            entry.innerText = `[${time}] ${msg}`;
            el.insertBefore(entry, el.firstChild);
        }

        function initLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                const coords = [p.coords.latitude, p.coords.longitude];
                currentPos = coords;
                map.setView(coords, 17);
                carMarker = L.marker(coords, { icon: carIcon }).addTo(map);
                trail = L.polyline([], { color: '#30d158', weight: 4, opacity: 0.5 }).addTo(map);
                
                document.getElementById('loader').style.display = 'none';
                document.getElementById('ui').style.display = 'flex';
                log("Location Locked. Systems Ready.", "sys");
            }, e => {
                alert("GPS Denied. Please enable location services.");
            });
        }

        async function scanIntersections() {
            document.getElementById('statusVal').innerText = "SCANNING";
            document.getElementById('statusVal').style.color = "#ff9f0a";
            log("Analyzing possible exits from current node...");

            const angles = [0, 90, -90, 45, -45, 180];
            const possibleRoutes = [];

            // Parallel scan of directions
            const scans = await Promise.all(angles.map(async angle => {
                const targetRad = (currentBearing + angle) * (Math.PI / 180);
                const dest = [
                    currentPos[0] + Math.cos(targetRad) * 0.015,
                    currentPos[1] + Math.sin(targetRad) * 0.015
                ];
                const url = `https://router.project-osrm.org/route/v1/driving/${currentPos[1]},${currentPos[0]};${dest[1]},${dest[0]}?overview=full&geometries=geojson&steps=true`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.routes && data.routes.length > 0) {
                        const step = data.routes[0].legs[0].steps[1] || data.routes[0].legs[0].steps[0];
                        return { 
                            angle, 
                            data: data.routes[0], 
                            name: step.name || "Unnamed Road",
                            instruction: step.maneuver.instruction 
                        };
                    }
                } catch (e) {}
                return null;
            }));

            const validRoutes = scans.filter(s => s !== null);
            
            if (validRoutes.length === 0) {
                log("No exits found. Recalibrating GPS...", "error");
                currentBearing += 45;
                return scanIntersections();
            }

            const routeLabels = validRoutes.map(r => {
                if (r.angle === 0) return "Straight (" + r.name + ")";
                if (r.angle === 90) return "Right (" + r.name + ")";
                if (r.angle === -90) return "Left (" + r.name + ")";
                return "Turn (" + r.name + ")";
            });

            log("Options Found: " + routeLabels.join(", "), "sys");

            // Pick a route (prefer non-U-turns)
            const forwardRoutes = validRoutes.filter(r => r.angle !== 180);
            const chosen = (forwardRoutes.length > 0 ? forwardRoutes : validRoutes)[Math.floor(Math.random() * (forwardRoutes.length || validRoutes.length))];
            
            routeCoords = chosen.data.geometry.coordinates.map(c => [c[1], c[0]]);
            currentManeuvers = chosen.data.legs[0].steps;
            currentIndex = 0;

            if (activePath) map.removeLayer(activePath);
            activePath = L.polyline(routeCoords, { color: '#0a84ff', weight: 6, opacity: 0.3 }).addTo(map);

            log("Decision: " + chosen.instruction, "decision");
            document.getElementById('statusVal').innerText = "DRIVING";
            document.getElementById('statusVal').style.color = var(--accent);
            
            driveLoop();
        }

        function driveLoop() {
            if (!isDriving) return;

            if (currentIndex >= routeCoords.length) {
                log("Intersection reached.");
                scanIntersections();
                return;
            }

            const now = routeCoords[currentIndex];
            const next = routeCoords[currentIndex + 1];

            // Intersection Check (End of Step 0)
            const firstStepEnd = currentManeuvers[0]?.geometry?.coordinates;
            if (firstStepEnd) {
                const endCoord = [firstStepEnd[firstStepEnd.length-1][1], firstStepEnd[firstStepEnd.length-1][0]];
                if (Math.abs(now[0] - endCoord[0]) < 0.0001 && Math.abs(now[1] - endCoord[1]) < 0.0001 && currentIndex > 5) {
                    log("Approaching decision point...");
                    scanIntersections();
                    return;
                }
            }

            currentPos = now;
            carMarker.setLatLng(now);
            trail.addLatLng(now);
            map.panTo(now, { animate: true, duration: 0.1 });

            totalMiles += 0.004;
            document.getElementById('odoVal').innerText = totalMiles.toFixed(2);

            if (next) {
                const angle = Math.atan2(next[1] - now[1], next[0] - now[0]) * 180 / Math.PI;
                currentBearing = angle;
                document.getElementById('car').style.transform = `rotate(${90 - angle}deg)`;
                
                const dirs = ["E", "NE", "N", "NW", "W", "SW", "S", "SE"];
                const dIdx = Math.round(((angle %= 360) < 0 ? angle + 360 : angle) / 45) % 8;
                document.getElementById('dirVal').innerText = dirs[dIdx];
            }

            currentIndex++;
            driveTimeout = setTimeout(driveLoop, 150);
        }

        document.getElementById('driveBtn').onclick = () => {
            if (!isDriving) {
                isDriving = true;
                document.getElementById('driveBtn').innerText = "Emergency Stop";
                document.getElementById('driveBtn').classList.add('btn-stop');
                scanIntersections();
            } else {
                isDriving = false;
                document.getElementById('driveBtn').innerText = "Resume Mission";
                document.getElementById('driveBtn').classList.remove('btn-stop');
                document.getElementById('statusVal').innerText = "PAUSED";
                document.getElementById('statusVal').style.color = "#8e8e93";
                clearTimeout(driveTimeout);
            }
        };

        initLocation();
    </script>
</body>
</html>
