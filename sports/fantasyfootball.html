<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Gridiron | Professional League Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #22c55e;
            --primary-hover: #16a34a;
            --bg-dark: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, h3, .font-heading { font-family: 'Outfit', sans-serif; }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
        }

        .nav-btn {
            transition: all 0.2s ease;
            position: relative;
        }
        .nav-btn.active {
            color: var(--primary);
        }
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
            border-radius: 2px;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        .draft-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .draft-item:hover {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(34, 197, 94, 0.39);
        }
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.23);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- App Shell -->
    <div class="max-w-7xl mx-auto w-full flex flex-col gap-8 min-h-screen">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row items-center justify-between gap-6 shrink-0">
            <div class="flex items-center gap-4 cursor-pointer" onclick="switchTab('dashboard')">
                <div class="w-14 h-14 bg-green-600 rounded-2xl flex items-center justify-center text-white font-black text-3xl italic shadow-lg shadow-green-900/20">
                    üèà
                </div>
                <div>
                    <h1 class="text-3xl font-black uppercase tracking-tighter italic leading-none">Fantasy Gridiron</h1>
                    <p class="text-[10px] text-green-400 font-bold uppercase tracking-[0.2em] mt-1">League Management ‚Ä¢ Mock Drafts ‚Ä¢ Analytics</p>
                </div>
            </div>

            <!-- Main Navigation -->
            <nav class="flex flex-wrap bg-slate-800/50 backdrop-blur-md p-1.5 rounded-2xl border border-white/5 gap-1">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn active px-4 py-2 rounded-xl text-[10px] font-black uppercase">Home</button>
                <button onclick="switchTab('prospects')" id="nav-prospects" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Prospects</button>
                <button onclick="switchTab('draft')" id="nav-draft" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Mock Draft</button>
                <button onclick="switchTab('rosters')" id="nav-rosters" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Database</button>
                <button onclick="switchTab('news')" id="nav-news" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">News</button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Settings</button>
            </nav>
        </header>

        <!-- Initial Loader -->
        <div id="init-loader" class="flex-grow flex flex-col items-center justify-center gap-6 py-20">
            <div class="relative">
                <div class="loader w-16 h-16 border-4"></div>
                <div class="absolute inset-0 flex items-center justify-center text-xl">üèà</div>
            </div>
            <div class="text-center">
                <p id="loading-text" class="text-sm font-black text-white uppercase tracking-widest">Scouting the NFL...</p>
                <div class="w-64 bg-slate-800 rounded-full h-1.5 mt-4 overflow-hidden">
                    <div id="progress-bar" class="bg-green-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Home View -->
        <main id="view-dashboard" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="glass-panel p-8">
                <h2 class="text-2xl font-black uppercase italic mb-6">League Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="stat-card p-6 rounded-2xl">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Active Players</span>
                        <div class="text-3xl font-black mt-1" id="stat-players">0</div>
                    </div>
                    <div class="stat-card p-6 rounded-2xl">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">NFL Teams</span>
                        <div class="text-3xl font-black mt-1" id="stat-teams">0</div>
                    </div>
                    <div class="stat-card p-6 rounded-2xl">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Draft Status</span>
                        <div class="text-lg font-black mt-1 text-green-500" id="stat-draft">Ready</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Prospects View -->
        <main id="view-prospects" class="hidden animate-fade-in flex flex-col gap-6 overflow-hidden h-full">
            <div class="shrink-0">
                <h2 class="text-3xl font-black uppercase italic">Top 50 Prospects <span class="text-green-500 font-black">By Position</span></h2>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Real-time Performance Ranking ‚Ä¢ 2025-26 Season</p>
            </div>
            <div id="prospects-grid" class="flex gap-4 overflow-x-auto flex-grow custom-scrollbar pb-4 min-h-0">
                <!-- Columns for QB, RB, WR, TE, K, D/ST -->
            </div>
        </main>

        <!-- News View -->
        <main id="view-news" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="glass-panel p-8">
                <h2 class="text-3xl font-black uppercase italic mb-8 underline decoration-green-500 underline-offset-8">NFL Pulse <span class="text-sm font-bold text-slate-500 ml-4">Live Insights</span></h2>
                <div id="news-feed-full" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- News items injected here -->
                </div>
            </div>
        </main>

        <!-- Draft View -->
        <main id="view-draft" class="hidden animate-fade-in flex flex-col gap-6 h-full">
            <!-- Top Controls -->
            <div class="glass-panel p-4 flex flex-col sm:flex-row items-center justify-between gap-4 shrink-0">
                <div class="flex items-center gap-6">
                    <div class="flex gap-2">
                        <button id="btn-start-draft" onclick="initiateDraft()" class="btn-primary px-8 py-3 rounded-xl text-sm">
                            Start Mock Draft
                        </button>
                        <button id="btn-pause-draft" onclick="togglePauseDraft()" style="display:none" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl text-sm font-black uppercase transition">
                            Pause
                        </button>
                        <button id="btn-restart-draft" onclick="restartDraft()" style="display:none" class="bg-red-600/20 hover:bg-red-600 text-red-500 hover:text-white px-6 py-3 rounded-xl text-sm font-black uppercase transition border border-red-500/30">
                            Restart
                        </button>
                    </div>
                    <div id="draft-status-indicator" class="flex items-center gap-3">
                        <span id="draft-clock" class="text-2xl font-mono font-black text-slate-500">01:30</span>
                        <div class="h-8 w-px bg-white/10"></div>
                        <div class="flex flex-col">
                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Current Pick</span>
                            <span id="current-pick-display" class="text-xs font-bold text-white">Draft Not Started</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleDraftLog()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-[10px] font-black uppercase transition">View Selection Log</button>
                </div>
            </div>

            <!-- Draft Room Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full min-h-[700px]">
                
                <!-- Left: Draft Board -->
                <div class="lg:col-span-1 glass-panel p-6 flex flex-col gap-6 overflow-hidden">
                    <h2 class="text-xl font-black uppercase italic">Draft Board</h2>
                    <div id="draft-order" class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow pr-1">
                        <!-- Draft order list with position counts -->
                    </div>
                </div>

                <!-- Center: Player Pool -->
                <div class="lg:col-span-2 glass-panel p-4 md:p-6 flex flex-col gap-4 md:gap-6">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <h2 class="text-xl font-black uppercase italic text-green-500">Available Talent</h2>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <select id="draft-sort" onchange="filterDraftPool()" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-[10px] font-black uppercase focus:outline-none focus:border-green-500">
                                <option value="stats-cur">25-26 Stats</option>
                                <option value="stats-prev">Prev Season</option>
                                <option value="career">Career Stats</option>
                                <option value="exp">Experience</option>
                            </select>
                            <div class="relative w-full sm:w-48">
                                <input type="text" id="draft-search" oninput="filterDraftPool()" placeholder="Search..." class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-xs focus:outline-none focus:border-green-500">
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setDraftFilter('ALL')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-green-600 text-white shrink-0">All</button>
                        <button onclick="setDraftFilter('QB')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">QB</button>
                        <button onclick="setDraftFilter('RB')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">RB</button>
                        <button onclick="setDraftFilter('WR')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">WR</button>
                        <button onclick="setDraftFilter('TE')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">TE</button>
                        <button onclick="setDraftFilter('K')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">K</button>
                        <button onclick="setDraftFilter('D/ST')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">D/ST</button>
                    </div>

                    <div id="draft-pool" class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow pr-1 max-h-[500px] lg:max-h-none">
                        <!-- Player cards for drafting -->
                    </div>
                </div>

                <!-- Right: Roster Viewer -->
                <div class="lg:col-span-1 glass-panel p-6 flex flex-col gap-6">
                    <div class="flex flex-col gap-2">
                        <h2 class="text-xl font-black uppercase italic">Team Roster</h2>
                        <select id="roster-view-selector" onchange="renderDraftRoom()" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-[10px] font-black uppercase focus:outline-none focus:border-green-500">
                            <!-- Populated in renderDraftRoom -->
                        </select>
                    </div>
                    <div id="my-draft-roster" class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow">
                        <!-- Slots for selected team -->
                    </div>
                </div>
            </div>

            <!-- Selection Log Overlay -->
            <div id="draft-log-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[2000] hidden flex-col items-center justify-center p-8">
                <div class="glass-panel w-full max-w-2xl max-h-[80vh] flex flex-col p-8 gap-6 border-white/10">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-black uppercase italic">Selection Log</h2>
                        <button onclick="toggleDraftLog()" class="text-3xl text-slate-500 hover:text-white">&times;</button>
                    </div>
                    <div id="draft-log-content" class="flex-grow overflow-y-auto custom-scrollbar pr-4 space-y-2">
                        <!-- Log entries injected here -->
                    </div>
                </div>
            </div>
        </main>

        <!-- Players View -->
        <main id="view-rosters" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="glass-panel p-8">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
                    <h2 class="text-2xl font-black uppercase italic">Pro Player Database</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                        <input type="text" id="roster-search" oninput="filterRosterPlayers()" placeholder="Search name..." class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-green-500 w-full md:w-48">
                        <select id="roster-team-filter" onchange="filterRosterPlayers()" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-green-500">
                            <option value="ALL">All Teams</option>
                            <!-- Teams injected here -->
                        </select>
                        <select id="roster-pos-filter" onchange="filterRosterPlayers()" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-green-500">
                            <option value="ALL">All Positions</option>
                            <option value="QB">Quarterbacks</option>
                            <option value="RB">Running Backs</option>
                            <option value="WR">Wide Receivers</option>
                            <option value="TE">Tight Ends</option>
                            <option value="K">Kickers</option>
                            <option value="D/ST">Defense</option>
                        </select>
                    </div>
                </div>

                <div id="full-roster-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Roster cards injected here -->
                </div>

                <div class="mt-8 flex justify-center">
                    <button onclick="loadMorePlayers()" id="btn-load-more" class="px-8 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl font-black uppercase text-xs tracking-widest transition">Load More Athletes</button>
                </div>
            </div>
        </main>

        <!-- Settings View -->
        <main id="view-settings" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- League Format -->
                <div class="glass-panel p-8">
                    <h2 class="text-2xl font-black uppercase italic mb-8">League Configuration</h2>
                    <div class="space-y-6">
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Teams in League</label>
                            <select id="setting-teams" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-green-500">
                                <option value="8">8 Teams</option>
                                <option value="10" selected>10 Teams</option>
                                <option value="12">12 Teams</option>
                                <option value="14">14 Teams</option>
                                <option value="16">16 Teams</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Draft Type</label>
                            <select id="setting-draft-type" onchange="toggleAuctionSettings()" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-green-500">
                                <option value="snake" selected>Snake Draft</option>
                                <option value="linear">Linear (Fixed Order)</option>
                                <option value="random">Random Round</option>
                                <option value="auction">Auction (Salary Cap)</option>
                            </select>
                        </div>
                        <div id="auction-budget-wrap" class="hidden flex-col gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Auction Budget ($)</label>
                            <input type="number" id="setting-auction-budget" value="200" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-green-500">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">League Mode</label>
                            <select id="setting-league-mode" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-green-500">
                                <option value="standard">Standard Head-to-Head</option>
                                <option value="std_avg">Standard + League Median</option>
                                <option value="guillotine">Guillotine (Lowest Score Eliminated)</option>
                                <option value="points">Total Points Only</option>
                            </select>
                            <p class="text-[9px] text-slate-500 italic px-1">
                                * Guillotine: Lowest scoring team is eliminated each week. Roster drops to waivers.
                            </p>
                        </div>
                        <div class="pt-4">
                            <h3 class="text-sm font-black text-slate-300 uppercase mb-4">Roster Limits (Max)</h3>
                            <div id="pos-limits" class="grid grid-cols-3 gap-3">
                                <!-- Position Limit inputs injected via JS -->
                            </div>
                        </div>
                        <div class="pt-4">
                            <h3 class="text-sm font-black text-slate-300 uppercase mb-4">Starting Roster Slots</h3>
                            <div id="roster-slots" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                <!-- Position slot inputs -->
                            </div>
                        </div>
                        <div class="pt-8">
                            <h3 class="text-sm font-black text-slate-300 uppercase mb-4">League Teams & Divisions</h3>
                            <div id="team-division-settings" class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                                <!-- Team name and division inputs injected here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scoring Settings -->
                <div class="glass-panel p-8">
                    <h2 class="text-2xl font-black uppercase italic mb-8">Scoring Settings</h2>
                    <div class="flex gap-4 mb-6">
                        <button onclick="setScoringPreset('standard')" class="preset-btn flex-1 py-2 bg-slate-800 rounded-lg text-[10px] font-black uppercase hover:bg-slate-700 transition">Standard</button>
                        <button onclick="setScoringPreset('half')" class="preset-btn flex-1 py-2 bg-slate-800 rounded-lg text-[10px] font-black uppercase hover:bg-slate-700 transition">Half PPR</button>
                        <button onclick="setScoringPreset('full')" class="preset-btn flex-1 py-2 bg-green-600 text-white rounded-lg text-[10px] font-black uppercase transition">Full PPR</button>
                    </div>

                    <div class="space-y-4 custom-scrollbar max-h-[500px] overflow-y-auto pr-2">
                        <!-- Passing -->
                        <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <h4 class="text-xs font-black text-blue-400 uppercase mb-3">Passing</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Passing TD</span>
                                    <input type="number" step="0.5" id="score-pass-td" value="4" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Passing Yards</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] text-slate-500">1 pt per</span>
                                        <input type="number" id="score-pass-yds" value="25" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Interception</span>
                                    <input type="number" step="0.5" id="score-pass-int" value="-2" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                            </div>
                        </div>

                        <!-- Rushing/Receiving -->
                        <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <h4 class="text-xs font-black text-green-400 uppercase mb-3">Rushing & Receiving</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Rushing/Rec TD</span>
                                    <input type="number" step="0.5" id="score-rush-td" value="6" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Rushing/Rec Yards</span>
                                    <div class="flex items-center gap-2">
                                        <span class="text-[10px] text-slate-500">1 pt per</span>
                                        <input type="number" id="score-rush-yds" value="10" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Reception (PPR)</span>
                                    <input type="number" step="0.1" id="score-ppr" value="1" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                            </div>
                        </div>

                        <!-- Kicker -->
                        <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <h4 class="text-xs font-black text-yellow-400 uppercase mb-3">Kicking</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">FG Made</span>
                                    <input type="number" step="0.5" id="score-fg-made" value="3" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">XP Made</span>
                                    <input type="number" step="0.5" id="score-xp-made" value="1" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                            </div>
                        </div>

                        <!-- Defense -->
                        <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <h4 class="text-xs font-black text-red-400 uppercase mb-3">Team Defense</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Sack</span>
                                    <input type="number" step="0.5" id="score-def-sack" value="1" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Interception</span>
                                    <input type="number" step="0.5" id="score-def-int" value="2" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Safety</span>
                                    <input type="number" step="0.5" id="score-def-saf" value="2" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-300">Defensive TD</span>
                                    <input type="number" step="0.5" id="score-def-td" value="6" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveSettings()" class="w-full mt-8 btn-primary py-4 rounded-xl">Save All Configurations</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-auto py-12 border-t border-white/5 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üèà</span>
                <span class="text-xs font-black uppercase tracking-widest text-slate-500">Fantasy Gridiron v1.0.4</span>
            </div>
            <p class="text-[10px] text-slate-600 uppercase font-bold text-center">Data provided by ESPN V2 Sports API ‚Ä¢ Build for Kevin Keegan</p>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-8 right-8 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-green-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 font-black uppercase text-xs">
            <span id="toast-icon">‚úÖ</span>
            <span id="toast-msg">Settings Saved</span>
        </div>
    </div>

    <script>
        // --- API CONFIG ---
        const API_BASE = "https://site.api.espn.com/apis/site/v2/sports/football/nfl";
        const TEAMS_URL = `${API_BASE}/teams`;
        const ROSTER_URL = (id) => `${API_BASE}/teams/${id}/roster`;
        const NEWS_URL = `${API_BASE}/news`;

        // --- STATE ---
        let appData = {
            teams: [],
            players: [],
            news: [],
            currentTab: 'dashboard',
            settings: {
                teamsCount: 10,
                draftType: 'snake',
                leagueMode: 'standard', // standard, std_avg, guillotine
                posLimits: { QB: 2, RB: 8, WR: 8, TE: 3, K: 2, 'D/ST': 2 },
                auctionBudget: 200,
                teamConfigs: [], 
                rosterPositions: {
                    QB: 1, RB: 2, WR: 2, TE: 1, FLEX: 1, K: 1, 'D/ST': 1, BENCH: 6
                },
                scoring: {
                    passTD: 4, passYds: 25, passInt: -2,
                    rushTD: 6, rushYds: 10, recTD: 6, recYds: 10, ppr: 1,
                    fgMade: 3, xpMade: 1,
                    defSack: 1, defInt: 2, defSaf: 2, defTD: 6, defPtsAllowed: -0.5
                }
            },
            draft: {
                active: false,
                paused: false,
                currentPick: 1,
                round: 1,
                teams: [], 
                availablePlayers: [],
                filter: 'ALL',
                log: [],
                pickOrders: [] // Stores team indices per round for random drafts
            }
        };

        // --- INITIALIZATION ---
        async function init() {
            try {
                updateProgress(10, "Fetching NFL Teams...");
                const teamsRes = await fetch(TEAMS_URL);
                const teamsData = await teamsRes.json();
                appData.teams = teamsData.sports[0].leagues[0].teams.map(t => t.team);
                
                // Initialize Default Team Configs
                if (appData.settings.teamConfigs.length === 0) {
                    for (let i = 0; i < 16; i++) {
                        appData.settings.teamConfigs.push({
                            id: i,
                            name: i === 0 ? "My Dynasty" : `Rival Team ${i}`,
                            division: i < 8 ? "East" : "West"
                        });
                    }
                }

                updateProgress(30, "Scouting Rosters...");
                await fetchAllRosters();
                
                updateProgress(70, "Gathering NFL News...");
                await fetchNews();

                updateProgress(90, "Finalizing UI...");
                setupUI();
                
                updateProgress(100, "Ready!");
                setTimeout(() => {
                    document.getElementById('init-loader').classList.add('hidden');
                    document.getElementById('view-dashboard').classList.remove('hidden');
                    renderDashboard();
                }, 800);

            } catch (err) {
                console.error("Initialization failed:", err);
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = "Failed to load NFL data. Please refresh.";
                    loadingText.classList.add('text-red-500');
                }
            }
        }

        async function fetchAllRosters() {
            const teamIds = appData.teams.map(t => t.id);
            updateProgress(20, "Scouting NFL Teams...");
            
            // Parallel fetch all rosters (32 teams at once)
            await Promise.all(teamIds.map(async (id) => {
                try {
                    const res = await fetch(ROSTER_URL(id));
                    const data = await res.json();
                    const team = appData.teams.find(t => t.id === id);
                    
                    data.athletes.forEach(group => {
                        group.items.forEach(p => {
                            p.teamAbbr = team.abbreviation;
                            p.teamLogo = team.logos[0].href;
                            // Explicit zero start
                            p.stats2025 = { passYds: 0, passTd: 0, rushYds: 0, rushTd: 0, recYds: 0, recTd: 0, rec: 0, int: 0, points: 0 };
                            p.careerStats = { passYds: 0, passTd: 0, rushYds: 0, rushTd: 0, recYds: 0, recTd: 0, rec: 0, int: 0, points: 0 };
                            
                            // Add D/ST specific fields for later
                            if(p.position.abbreviation === 'D/ST') {
                                p.stats2025.sacks = 0; p.stats2025.safeties = 0; p.stats2025.defTd = 0;
                                p.careerStats.sacks = 0; p.careerStats.safeties = 0; p.careerStats.defTd = 0;
                            }
                            
                            appData.players.push(p);
                        });
                    });
                } catch (e) { console.error("Roster fetch failed", id); }
            }));
            
            const validPositions = ['QB', 'RB', 'WR', 'TE', 'K', 'PK', 'D/ST'];
            appData.players = appData.players.filter(p => p.position && validPositions.includes(p.position.abbreviation));
            appData.players.forEach(p => { if(p.position.abbreviation === 'PK') p.position.abbreviation = 'K'; });
            
            // Render basic UI so user isn't stuck on a black screen
            document.getElementById('init-loader').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            renderDashboard();

            // Now perform Deep Parallel Sync in background
            await deepStatSync();
        }

        async function deepStatSync() {
            const batchSize = 100; // 100x Parallel
            const total = appData.players.length;
            
            // Show background sync status
            const syncToast = document.createElement('div');
            syncToast.id = "sync-toast";
            syncToast.className = "fixed bottom-24 right-8 z-50 bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-3 shadow-2xl";
            syncToast.innerHTML = `<span>üîÑ</span> <span id="sync-count">Syncing Stats: 0/${total}</span>`;
            document.body.appendChild(syncToast);

            for (let i = 0; i < total; i += batchSize) {
                const batch = appData.players.slice(i, i + batchSize);
                await Promise.all(batch.map(p => fetchRealAthleteStats(p)));
                
                const count = Math.min(i + batchSize, total);
                document.getElementById('sync-count').textContent = `Syncing Stats: ${count}/${total}`;
                
                // Update UI in real-time as data streams in
                if (appData.currentTab === 'dashboard') renderDashboard();
                if (appData.currentTab === 'prospects') renderProspects();
                if (appData.currentTab === 'rosters') filterRosterPlayers();
                if (appData.currentTab === 'draft') filterDraftPool();
            }
            
            setTimeout(() => {
                const el = document.getElementById('sync-toast');
                if(el) el.remove();
            }, 2000);
        }

        async function fetchRealAthleteStats(player) {
            const STATS_2025_URL = `https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/seasons/2025/types/2/athletes/${player.id}/statistics`;
            const CAREER_URL = `https://sports.core.api.espn.com/v2/sports/football/leagues/nfl/athletes/${player.id}/statistics`;
            
            try {
                const [res2025, resCareer] = await Promise.all([
                    fetch(STATS_2025_URL).then(r => r.ok ? r.json() : null),
                    fetch(CAREER_URL).then(r => r.ok ? r.json() : null)
                ]);

                const parseCoreStats = (data) => {
                    if (!data) return null;
                    let categories = data.categories;
                    if (!categories && data.splits) categories = data.splits.categories;
                    if (!categories) return null;
                    
                    const s = { 
                        passYds: 0, passTd: 0, rushYds: 0, rushTd: 0, recYds: 0, recTd: 0, rec: 0, int: 0,
                        fgMade: 0, xpMade: 0, sacks: 0, safeties: 0, defTd: 0
                    };
                    
                    categories.forEach(cat => {
                        if (!cat.stats) return;
                        cat.stats.forEach(stat => {
                            const n = stat.name;
                            const v = parseFloat(stat.value) || 0;
                            if (n === 'passingYards') s.passYds = v;
                            if (n === 'passingTouchdowns') s.passTd = v;
                            if (n === 'interceptions') s.int = v;
                            if (n === 'rushingYards') s.rushYds = v;
                            if (n === 'rushingTouchdowns') s.rushTd = v;
                            if (n === 'receivingYards') s.recYds = v;
                            if (n === 'receivingTouchdowns') s.recTd = v;
                            if (n === 'receptions') s.rec = v;
                            if (n === 'fieldGoalsMade') s.fgMade = v;
                            if (n === 'extraPointsMade') s.xpMade = v;
                            if (n === 'sacks') s.sacks = v;
                            if (n === 'safeties') s.safeties = v;
                            if (n === 'defensiveTouchdowns') s.defTd = v;
                        });
                    });
                    return s;
                };

                const real2025 = parseCoreStats(res2025);
                const realCareer = parseCoreStats(resCareer);

                if (real2025) {
                    player.stats2025 = real2025;
                    player.stats2025.points = calculateFantasyPoints(player.stats2025, player.position.abbreviation);
                }
                if (realCareer) {
                    player.careerStats = realCareer;
                    player.careerStats.points = calculateFantasyPoints(player.careerStats, player.position.abbreviation);
                }
            } catch (e) { }
        }

        function calculateFantasyPoints(stats, pos) {
            const s = appData.settings.scoring;
            let pts = 0;
            
            if (pos === 'K') {
                pts += ((stats.fgMade || 0) * s.fgMade);
                pts += ((stats.xpMade || 0) * s.xpMade);
                return Math.round(pts);
            }
            if (pos === 'D/ST') {
                pts += ((stats.sacks || 0) * s.defSack);
                pts += ((stats.int || 0) * s.defInt);
                pts += ((stats.safeties || 0) * s.defSaf);
                pts += ((stats.defTd || 0) * s.defTD);
                return Math.max(0, Math.round(pts));
            }

            // Standard Skill Positions
            pts += (stats.passYds / s.passYds);
            pts += (stats.passTd * s.passTD);
            pts -= (stats.int * Math.abs(s.passInt));
            
            pts += (stats.rushYds / s.rushYds);
            pts += (stats.rushTd * s.rushTD);
            pts += (stats.recYds / s.recYds);
            pts += (stats.recTd * s.recTD);
            pts += (stats.rec * s.ppr);
            
            return Math.round(pts);
        }

        function getStatLine(stats, pos) {
            if (pos === 'QB') return `${Math.round(stats.passYds)} PASS ‚Ä¢ ${stats.passTd} TD`;
            if (pos === 'RB') return `${Math.round(stats.rushYds + stats.recYds)} TOT YDS ‚Ä¢ ${stats.rushTd + stats.recTd} TD`;
            if (pos === 'WR' || pos === 'TE') return `${Math.round(stats.recYds)} REC YDS ‚Ä¢ ${stats.rec} REC`;
            if (pos === 'K') return `${stats.fgMade || 0} FG ‚Ä¢ ${stats.xpMade || 0} XP`;
            if (pos === 'D/ST') return `${stats.sacks || 0} SACKS ‚Ä¢ ${stats.int || 0} INT`;
            return `Active Pro`;
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            appData.currentTab = tab;
            const viewEl = document.getElementById(`view-${tab}`);
            if (viewEl) viewEl.classList.remove('hidden');
            const navEl = document.getElementById(`nav-${tab}`);
            if (navEl) navEl.classList.add('active');

            if(tab === 'dashboard') renderDashboard();
            if(tab === 'prospects') renderProspects();
            if(tab === 'rosters') renderRosters();
            if(tab === 'draft') renderDraftRoom();
            if(tab === 'news') renderNews();
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            document.getElementById('stat-players').textContent = appData.players.length.toLocaleString();
            document.getElementById('stat-teams').textContent = appData.teams.length;
        }

        // --- PROSPECTS ---
        function renderProspects() {
            const positions = ['QB', 'RB', 'WR', 'TE', 'K', 'D/ST'];
            const grid = document.getElementById('prospects-grid');
            if (!grid) return;

            grid.innerHTML = positions.map(pos => {
                const filtered = appData.players
                    .filter(p => p.position.abbreviation === pos)
                    .sort((a, b) => b.stats2025.points - a.stats2025.points)
                    .slice(0, 50);

                return `
                    <div class="flex flex-col gap-4 bg-slate-900/30 p-4 rounded-2xl border border-white/5 min-w-[280px] shrink-0">
                        <div class="flex items-center justify-between border-b border-white/10 pb-2">
                            <h3 class="text-xl font-black italic text-green-500">${pos}</h3>
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Top 50</span>
                        </div>
                        <div class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow pr-1">
                            ${filtered.map((p, idx) => `
                                <div class="flex items-center gap-3 p-2 bg-slate-800/40 rounded-xl hover:bg-slate-800 transition cursor-help border border-transparent hover:border-green-500/30 shrink-0">
                                    <span class="text-[10px] font-black text-slate-600 w-4 shrink-0">${idx + 1}</span>
                                    <div class="relative shrink-0">
                                        <img src="${p.headshot?.href || 'https://a.espncdn.com/i/headshots/nfl/players/full/0.png'}" class="w-8 h-8 rounded-lg bg-slate-900 border border-slate-700">
                                        <img src="${p.teamLogo}" class="absolute -bottom-1 -right-1 w-3 h-3">
                                    </div>
                                    <div class="min-w-0 flex-grow">
                                        <div class="text-[10px] font-black uppercase text-white truncate">${p.displayName}</div>
                                        <div class="text-[8px] font-bold text-green-500 uppercase">${p.stats2025.points} PTS ‚Ä¢ ${p.teamAbbr}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- NEWS ---
        function renderNews() {
            const container = document.getElementById('news-feed-full');
            if (!container) return;

            container.innerHTML = appData.news.map(item => `
                <div onclick="window.open('${item.links?.web?.href || '#'}', '_blank')" class="glass-panel p-6 flex flex-col gap-4 hover:border-green-500/50 transition cursor-pointer group">
                    ${item.images && item.images[0] ? `<img src="${item.images[0].url}" class="w-full h-40 object-cover rounded-xl border border-white/5">` : ''}
                    <div>
                        <h4 class="text-sm font-black uppercase leading-snug group-hover:text-green-400 transition">${item.headline}</h4>
                        <p class="text-[10px] text-slate-400 mt-2 line-clamp-2">${item.description || ''}</p>
                        <div class="flex items-center justify-between mt-4 pt-4 border-t border-white/5">
                            <span class="text-[9px] font-black text-slate-500 uppercase">${item.published ? new Date(item.published).toLocaleDateString() : 'RECENT'}</span>
                            <span class="text-[9px] font-black text-green-500 uppercase tracking-widest">Read Full Story ‚Üí</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function playerCard(p) {
            const img = p.headshot ? p.headshot.href : 'https://a.espncdn.com/i/headshots/nfl/players/full/0.png';
            const pos = p.position.abbreviation;
            return `
                <div class="glass-panel p-4 flex gap-4 group hover:border-green-500/30 transition">
                    <img src="${img}" class="w-14 h-14 bg-slate-800 rounded-xl object-contain border border-slate-700">
                    <div class="flex-grow min-w-0">
                        <div class="flex justify-between items-start">
                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">${pos} ‚Ä¢ ${p.teamAbbr}</span>
                            <img src="${p.teamLogo}" class="w-4 h-4 opacity-50">
                        </div>
                        <h4 class="text-xs font-black uppercase text-white truncate mt-0.5">${p.displayName}</h4>
                        <div class="flex flex-col mt-1">
                            <p class="text-[9px] text-green-400 font-bold">${p.stats2025.points} FPTS <span class="text-slate-600 ml-1 font-normal">${getStatLine(p.stats2025, pos)}</span></p>
                            <p class="text-[8px] text-slate-500 uppercase font-black mt-0.5">Career: ${p.careerStats.points} PTS</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- ROSTERS ---
        let rosterOffset = 20;
        function renderRosters() {
            const grid = document.getElementById('full-roster-grid');
            const players = appData.players.slice(0, rosterOffset);
            grid.innerHTML = players.map(p => playerCardLarge(p)).join('');
        }

        function playerCardLarge(p) {
            const img = p.headshot ? p.headshot.href : 'https://a.espncdn.com/i/headshots/nfl/players/full/0.png';
            const pos = p.position.abbreviation;
            return `
                <div class="glass-panel p-6 flex flex-col items-center text-center gap-4 group hover:border-green-500/30 transition">
                    <div class="relative">
                        <img src="${img}" class="w-24 h-24 bg-slate-900 rounded-2xl object-contain border border-slate-700 group-hover:scale-105 transition-transform">
                        <img src="${p.teamLogo}" class="absolute -bottom-2 -right-2 w-8 h-8 drop-shadow-lg">
                    </div>
                    <div class="w-full">
                        <span class="text-[10px] font-black text-green-500 uppercase tracking-[0.2em]">${pos} ‚Ä¢ ${p.teamAbbr}</span>
                        <h4 class="text-sm font-black uppercase text-white mt-1">${p.displayName}</h4>
                        
                        <!-- 25-26 Season Stats -->
                        <div class="mt-4 p-3 bg-slate-900/50 rounded-xl border border-white/5">
                            <span class="block text-[8px] font-black text-slate-500 uppercase mb-2 tracking-widest text-left italic">25-26 SEASON</span>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-black text-green-400">${p.stats2025.points} <span class="text-[9px] font-bold opacity-50 uppercase">FPTS</span></span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase">${getStatLine(p.stats2025, pos)}</span>
                            </div>
                        </div>

                        <!-- Lifetime Stats -->
                        <div class="mt-2 p-3 bg-slate-900/50 rounded-xl border border-white/5">
                            <span class="block text-[8px] font-black text-slate-500 uppercase mb-2 tracking-widest text-left italic">LIFETIME CAREER</span>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-black text-white">${p.careerStats.points} <span class="text-[9px] font-bold opacity-50 uppercase">FPTS</span></span>
                                <span class="text-[10px] font-bold text-slate-400 uppercase">${getStatLine(p.careerStats, pos)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterRosterPlayers() {
            const search = document.getElementById('roster-search').value.toLowerCase();
            const pos = document.getElementById('roster-pos-filter').value;
            const team = document.getElementById('roster-team-filter').value;
            
            let filtered = appData.players.filter(p => {
                const matchSearch = p.displayName.toLowerCase().includes(search);
                const matchPos = pos === 'ALL' || p.position.abbreviation === pos;
                const matchTeam = team === 'ALL' || p.teamAbbr === team;
                return matchSearch && matchPos && matchTeam;
            });

            const grid = document.getElementById('full-roster-grid');
            grid.innerHTML = filtered.slice(0, rosterOffset).map(p => playerCardLarge(p)).join('');
            
            document.getElementById('btn-load-more').style.display = filtered.length > rosterOffset ? 'block' : 'none';
        }

        function loadMorePlayers() {
            rosterOffset += 20;
            filterRosterPlayers();
        }

        // --- DRAFT ROOM ---
        function renderDraftRoom() {
            const teamsCount = parseInt(appData.settings.teamsCount);
            const startBtn = document.getElementById('btn-start-draft');
            const clockEl = document.getElementById('draft-clock');
            
            if (appData.draft.active) {
                if (startBtn) startBtn.style.display = 'none';
                clockEl.classList.add('text-green-500');
                clockEl.classList.remove('text-slate-500');
                document.getElementById('btn-pause-draft').style.display = 'block';
                document.getElementById('btn-restart-draft').style.display = 'block';
            } else {
                if (startBtn) startBtn.style.display = 'block';
                clockEl.classList.remove('text-green-500');
                clockEl.classList.add('text-slate-500');
                document.getElementById('btn-pause-draft').style.display = 'none';
                document.getElementById('btn-restart-draft').style.display = 'none';
                
                if (appData.draft.teams.length === 0 || appData.draft.teams.length !== teamsCount) {
                    appData.draft.availablePlayers = [...appData.players].sort((a,b) => b.stats2025.points - a.stats2025.points);
                    appData.draft.teams = appData.settings.teamConfigs.slice(0, teamsCount).map(t => ({
                        id: t.id,
                        name: t.name,
                        division: t.division,
                        roster: [],
                        posCounts: { QB: 0, RB: 0, WR: 0, TE: 0, K: 0, 'D/ST': 0, FLEX: 0, BENCH: 0 }
                    }));
                    appData.draft.currentPick = 1;
                    appData.draft.round = 1;
                    appData.draft.log = [];
                }
                
                const selector = document.getElementById('roster-view-selector');
                if(selector) {
                    selector.innerHTML = appData.draft.teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                }
            }
            
            const selectedTeamId = parseInt(document.getElementById('roster-view-selector')?.value || 0);
            const selectedTeam = appData.draft.teams[selectedTeamId] || { roster: [] };
            const myRoster = document.getElementById('my-draft-roster');

            const currentRoster = [];
            Object.entries(appData.settings.rosterPositions).forEach(([pos, count]) => {
                for(let i=0; i<count; i++) currentRoster.push({ pos, player: null });
            });
            
            selectedTeam.roster.forEach(p => {
                const slot = currentRoster.find(s => s.pos === p.position.abbreviation && !s.player);
                if(slot) slot.player = p;
                else {
                    const flexSlot = currentRoster.find(s => s.pos === 'FLEX' && !s.player);
                    if(flexSlot) flexSlot.player = p;
                    else {
                        const benchSlot = currentRoster.find(s => s.pos === 'BENCH' && !s.player);
                        if(benchSlot) benchSlot.player = p;
                    }
                }
            });

            myRoster.innerHTML = currentRoster.map(s => `
                <div class="p-3 bg-slate-900/50 rounded-xl border ${s.player ? 'border-green-500/30 bg-green-900/10' : 'border-dashed border-slate-700'} flex items-center justify-between transition-all">
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] font-black text-slate-500 uppercase w-8">${s.pos}</span>
                        ${s.player ? `
                            <img src="${s.player.headshot?.href}" class="w-6 h-6 bg-slate-800 rounded">
                            <span class="text-xs font-black text-white uppercase truncate w-24 sm:w-auto">${s.player.displayName}</span>
                        ` : '<span class="text-[10px] italic text-slate-600">Empty</span>'}
                    </div>
                    ${s.player ? `<span class="text-[9px] font-bold text-slate-400">${s.player.teamAbbr}</span>` : ''}
                </div>
            `).join('');

            const order = document.getElementById('draft-order');
            order.innerHTML = appData.draft.teams.map((t, i) => {
                const isCurrent = getTurnIndex(appData.draft.currentPick, teamsCount) === i;
                if (isCurrent) document.getElementById('current-pick-display').textContent = `Pick ${appData.draft.currentPick}: ${t.name}`;
                
                return `
                    <div class="p-3 bg-slate-900/30 rounded-xl border ${isCurrent ? 'border-green-500 bg-green-900/20 shadow-lg shadow-green-500/10' : 'border-white/5'} flex flex-col gap-2 transition-all duration-300">
                        <div class="flex items-center gap-3">
                            <span class="text-xs font-black ${isCurrent ? 'text-green-500' : 'text-slate-500'}">${i + 1}</span>
                            <span class="text-xs font-black uppercase ${isCurrent ? 'text-white' : 'text-slate-400'} truncate">${t.name}</span>
                            ${isCurrent ? '<span class="ml-auto text-[8px] font-black text-green-500 animate-pulse">PICKING...</span>' : ''}
                        </div>
                        <div class="flex flex-wrap gap-1 mt-1 opacity-60">
                            ${Object.entries(t.posCounts).filter(([p, c]) => c > 0 && p !== 'FLEX' && p !== 'BENCH').map(([p, c]) => `
                                <span class="bg-slate-800 px-1.5 py-0.5 rounded text-[8px] font-bold">${p}:${c}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            filterDraftPool();
            renderDraftLog();
        }

        function getTurnIndex(pick, totalTeams) {
            const type = appData.settings.draftType;
            const round = Math.ceil(pick / totalTeams);
            const slot = (pick - 1) % totalTeams;
            
            if (type === 'snake') {
                return (round % 2 === 1) ? slot : (totalTeams - 1 - slot);
            }
            if (type === 'random' && appData.draft.pickOrders && appData.draft.pickOrders[round-1]) {
                return appData.draft.pickOrders[round-1][slot];
            }
            return slot;
        }

        let draftClockInterval = null;

        function initiateDraft() {
            if (appData.draft.active) return;
            
            const teamsCount = parseInt(appData.settings.teamsCount);
            const totalRounds = 16; 
            
            appData.draft.pickOrders = [];
            if (appData.settings.draftType === 'random') {
                for (let r = 0; r < totalRounds; r++) {
                    const order = Array.from({length: teamsCount}, (_, i) => i);
                    for (let j = order.length - 1; j > 0; j--) {
                        const k = Math.floor(Math.random() * (j + 1));
                        [order[j], order[k]] = [order[k], order[j]];
                    }
                    appData.draft.pickOrders.push(order);
                }
            }

            appData.draft.active = true;
            appData.draft.paused = false;
            
            showToast("üöÄ Draft Started!", "‚úÖ");
            
            startDraftClock();
            renderDraftRoom();
        }

        function startDraftClock() {
            if (draftClockInterval) clearInterval(draftClockInterval);
            let seconds = 90;
            const clockEl = document.getElementById('draft-clock');
            
            draftClockInterval = setInterval(() => {
                if (!appData.draft.active) {
                    clearInterval(draftClockInterval);
                    return;
                }
                
                if (appData.draft.paused) return;
                
                seconds--;
                if (seconds < 0) seconds = 90; 
                
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                clockEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                
                if (seconds < 15) {
                    clockEl.classList.add('animate-pulse');
                    clockEl.style.color = '#ef4444'; 
                } else {
                    clockEl.classList.remove('animate-pulse');
                    clockEl.style.color = ''; 
                }
            }, 1000);
        }

        function togglePauseDraft() {
            appData.draft.paused = !appData.draft.paused;
            const btn = document.getElementById('btn-pause-draft');
            if (btn) {
                btn.textContent = appData.draft.paused ? "Resume" : "Pause";
                btn.classList.toggle('bg-green-600', appData.draft.paused);
                btn.classList.toggle('bg-slate-800', !appData.draft.paused);
            }
            if (!appData.draft.paused) simulateCPUPicks();
        }

        function restartDraft() {
            if (confirm("Are you sure you want to restart the draft? All progress will be lost.")) {
                appData.draft.active = false;
                appData.draft.paused = false;
                appData.draft.teams = [];
                appData.draft.currentPick = 1;
                appData.draft.log = [];
                if (draftClockInterval) clearInterval(draftClockInterval);
                
                const clockEl = document.getElementById('draft-clock');
                if (clockEl) {
                    clockEl.textContent = "01:30";
                    clockEl.classList.remove('animate-pulse');
                    clockEl.style.color = '';
                }
                
                renderDraftRoom();
                showToast("Draft Reset", "üîÑ");
            }
        }

        function setDraftFilter(pos) {
            appData.draft.filter = pos;
            document.querySelectorAll('.draft-filter-btn').forEach(b => {
                b.classList.remove('bg-green-600', 'text-white');
                b.classList.add('bg-slate-800', 'text-slate-400');
                if(b.textContent === pos || (pos === 'ALL' && b.textContent === 'All')) {
                    b.classList.add('bg-green-600', 'text-white');
                    b.classList.remove('bg-slate-800', 'text-slate-400');
                }
            });
            filterDraftPool();
        }

        function filterDraftPool() {
            const search = document.getElementById('draft-search').value.toLowerCase();
            const pos = appData.draft.filter;
            const sort = document.getElementById('draft-sort').value;

            let filtered = appData.draft.availablePlayers.filter(p => {
                const matchSearch = p.displayName.toLowerCase().includes(search);
                const matchPos = pos === 'ALL' || p.position.abbreviation === pos;
                return matchSearch && matchPos;
            });

            filtered.sort((a, b) => {
                if (sort === 'stats-cur') return b.stats2025.points - a.stats2025.points;
                if (sort === 'stats-prev') return b.stats2024.points - a.stats2024.points; 
                if (sort === 'career') return b.careerStats.points - a.careerStats.points;
                return (b.experience?.years || 0) - (a.experience?.years || 0);
            });

            const pool = document.getElementById('draft-pool');
            pool.innerHTML = filtered.slice(0, 50).map(p => {
                const pos = p.position.abbreviation;
                return `
                <div class="draft-item p-3 glass-panel flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 border-white/5 group relative overflow-hidden">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="relative shrink-0">
                            <img src="${p.headshot?.href || 'https://a.espncdn.com/i/headshots/nfl/players/full/0.png'}" class="w-12 h-12 bg-slate-800 rounded-lg border border-slate-700">
                            <img src="${p.teamLogo}" class="absolute -bottom-1 -right-1 w-5 h-5 bg-slate-900 rounded-full border border-slate-700 p-0.5">
                        </div>
                        <div class="min-w-0">
                            <h4 class="text-xs font-black uppercase text-white truncate">${p.displayName}</h4>
                            <div class="flex flex-col">
                                <span class="text-[8px] font-black text-slate-500 uppercase">${pos} ‚Ä¢ ${p.teamAbbr}</span>
                                <span class="text-[9px] font-black text-green-400 uppercase">${p.stats2025.points} FPTS <span class="text-slate-500 ml-1 font-normal">${getStatLine(p.stats2025, pos)}</span></span>
                                <span class="text-[8px] font-black text-slate-400 uppercase mt-0.5 italic">Career: ${p.careerStats.points} PTS ‚Ä¢ ${getStatLine(p.careerStats, pos)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end w-full sm:w-auto gap-4">
                        <button onclick="draftToMyTeam('${p.id}')" class="flex-grow sm:flex-grow-0 px-5 py-2.5 bg-green-600/10 hover:bg-green-600 text-green-500 hover:text-white rounded-lg text-[10px] font-black uppercase transition-all shadow-sm">Draft</button>
                    </div>
                </div>
            `}).join('');
        }

        function draftToMyTeam(id) {
            const teamsCount = parseInt(appData.settings.teamsCount);
            const teamIndex = getTurnIndex(appData.draft.currentPick, teamsCount);
            
            if (teamIndex !== 0) {
                showToast(`It's Team ${teamIndex + 1}'s Turn!`, "‚ö†Ô∏è");
                return;
            }
            if(!appData.draft.active) {
                showToast("Start the draft first!", "‚ö†Ô∏è");
                return;
            }
            if(appData.draft.paused) {
                showToast("Draft is paused!", "‚ö†Ô∏è");
                return;
            }

            performDraftPick(id, teamIndex);
            setTimeout(simulateCPUPicks, 1000);
        }

        function performDraftPick(playerId, teamIndex) {
            const pIndex = appData.draft.availablePlayers.findIndex(x => x.id === playerId);
            if (pIndex === -1) return;

            const p = appData.draft.availablePlayers.splice(pIndex, 1)[0];
            const team = appData.draft.teams[teamIndex];
            
            team.roster.push(p);
            const pos = p.position.abbreviation;
            team.posCounts[pos] = (team.posCounts[pos] || 0) + 1;
            
            appData.draft.log.unshift({
                pick: appData.draft.currentPick,
                teamName: team.name,
                player: p
            });

            appData.draft.currentPick++;
            if (teamIndex === 0) showToast(`Drafted ${p.displayName}`, "üèà");
            renderDraftRoom();
        }

        function simulateCPUPicks() {
            const teamsCount = parseInt(appData.settings.teamsCount);
            let teamIndex = getTurnIndex(appData.draft.currentPick, teamsCount);

            if(teamIndex !== 0 && appData.draft.active && !appData.draft.paused && appData.draft.availablePlayers.length > 0) {
                const bestPlayer = findBestPlayerForTeam(teamIndex);
                performDraftPick(bestPlayer.id, teamIndex);
                
                const nextTeamIndex = getTurnIndex(appData.draft.currentPick, teamsCount);
                if(nextTeamIndex !== 0) {
                    setTimeout(simulateCPUPicks, 500); 
                } else {
                    showToast("Your Turn!", "üöÄ");
                }
            }
        }

        function findBestPlayerForTeam(teamIndex) {
            const team = appData.draft.teams[teamIndex];
            const rosterSettings = appData.settings.rosterPositions;
            const limits = appData.settings.posLimits;
            
            const needs = [];
            if (team.posCounts.QB < rosterSettings.QB) needs.push('QB');
            if (team.posCounts.RB < rosterSettings.RB) needs.push('RB');
            if (team.posCounts.WR < rosterSettings.WR) needs.push('WR');
            if (team.posCounts.TE < rosterSettings.TE) needs.push('TE');
            if (team.posCounts.K < rosterSettings.K) needs.push('K');
            if (team.posCounts['D/ST'] < rosterSettings['D/ST']) needs.push('D/ST');
            
            let candidates = appData.draft.availablePlayers.filter(p => {
                const pos = p.position.abbreviation;
                const currentCount = team.posCounts[pos] || 0;
                const limit = limits[pos] || 99;
                return currentCount < limit;
            });

            if (candidates.length === 0) return appData.draft.availablePlayers[0];

            if (needs.length > 0) {
                const priorityCandidates = candidates.filter(p => needs.includes(p.position.abbreviation));
                if (priorityCandidates.length > 0) candidates = priorityCandidates;
            }
            return candidates[0];
        }

        function renderDraftLog() {
            const container = document.getElementById('draft-log-content');
            if (!container) return;
            container.innerHTML = appData.draft.log.map(entry => `
                <div class="flex items-center gap-4 bg-slate-900/50 p-3 rounded-xl border border-white/5">
                    <span class="text-xs font-black text-slate-500 w-8">#${entry.pick}</span>
                    <div class="flex-grow">
                        <div class="text-[10px] font-black text-slate-400 uppercase">${entry.teamName}</div>
                        <div class="text-xs font-bold text-white uppercase">${entry.player.displayName} <span class="text-slate-500 ml-1">‚Ä¢ ${entry.player.position.abbreviation}</span></div>
                    </div>
                    <img src="${entry.player.teamLogo}" class="w-5 h-5 opacity-50">
                </div>
            `).join('');
        }

        function toggleDraftLog() {
            const overlay = document.getElementById('draft-log-overlay');
            overlay.classList.toggle('hidden');
            overlay.classList.toggle('flex');
        }

        function setScoringPreset(type) {
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('bg-green-600', 'text-white'));
            const btn = Array.from(document.querySelectorAll('.preset-btn')).find(b => b.textContent.toLowerCase().includes(type));
            if(btn) btn.classList.add('bg-green-600', 'text-white');

            const pprInput = document.getElementById('score-ppr');
            if(type === 'standard') pprInput.value = 0;
            if(type === 'half') pprInput.value = 0.5;
            if(type === 'full') pprInput.value = 1;
        }

        function updateTeamConfig(id, field, value) {
            const team = appData.settings.teamConfigs.find(t => t.id === id);
            if (team) team[field] = value;
        }

        function updateRosterSlot(pos, val) {
            appData.settings.rosterPositions[pos] = parseInt(val);
        }

        function saveSettings() {
            const newTeamsCount = parseInt(document.getElementById('setting-teams').value);
            appData.settings.teamsCount = newTeamsCount;
            appData.settings.draftType = document.getElementById('setting-draft-type').value;
            appData.settings.leagueMode = document.getElementById('setting-league-mode').value;
            appData.settings.auctionBudget = parseInt(document.getElementById('setting-auction-budget').value) || 200;

            const s = appData.settings.scoring;
            s.passTD = parseFloat(document.getElementById('score-pass-td').value);
            s.passYds = parseFloat(document.getElementById('score-pass-yds').value);
            s.passInt = parseFloat(document.getElementById('score-pass-int').value);
            s.rushTD = parseFloat(document.getElementById('score-rush-td').value);
            s.rushYds = parseFloat(document.getElementById('score-rush-yds').value);
            s.ppr = parseFloat(document.getElementById('score-ppr').value);
            s.fgMade = parseFloat(document.getElementById('score-fg-made').value);
            s.xpMade = parseFloat(document.getElementById('score-xp-made').value);
            s.defSack = parseFloat(document.getElementById('score-def-sack').value);
            s.defInt = parseFloat(document.getElementById('score-def-int').value);
            s.defSaf = parseFloat(document.getElementById('score-def-saf').value);
            s.defTD = parseFloat(document.getElementById('score-def-td').value);

            Object.keys(appData.settings.posLimits).forEach(pos => {
                const el = document.getElementById(`limit-${pos}`);
                if (el) appData.settings.posLimits[pos] = parseInt(el.value);
            });
            
            if (appData.draft.teams.length !== newTeamsCount) {
                appData.draft.active = false;
                appData.draft.teams = [];
                if (draftClockInterval) clearInterval(draftClockInterval);
            } else {
                appData.draft.teams.forEach((t, i) => {
                    const cfg = appData.settings.teamConfigs[i];
                    if (cfg) { t.name = cfg.name; t.division = cfg.division; }
                });
            }

            setupUI();
            if (appData.currentTab === 'draft') renderDraftRoom();
            showToast("Settings Saved", "‚úÖ");
        }

        function setupUI() {
            const teamSelect = document.getElementById('roster-team-filter');
            if(teamSelect) {
                const teams = [...new Set(appData.players.map(p => p.teamAbbr))].sort();
                teamSelect.innerHTML = '<option value="ALL">All Teams</option>' + 
                    teams.map(t => `<option value="${t}">${t}</option>`).join('');
            }

            const slotContainer = document.getElementById('roster-slots');
            slotContainer.innerHTML = Object.entries(appData.settings.rosterPositions).map(([pos, count]) => `
                <div class="flex flex-col gap-1">
                    <span class="text-[9px] font-black text-slate-500 uppercase">${pos}</span>
                    <input type="number" value="${count}" onchange="updateRosterSlot('${pos}', this.value)" class="bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-center outline-none focus:border-green-500">
                </div>
            `).join('');

            const limitContainer = document.getElementById('pos-limits');
            if (limitContainer) {
                limitContainer.innerHTML = Object.entries(appData.settings.posLimits).map(([pos, count]) => `
                    <div class="flex flex-col gap-1">
                        <span class="text-[9px] font-black text-slate-500 uppercase">${pos} MAX</span>
                        <input type="number" value="${count}" id="limit-${pos}" class="bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-center outline-none focus:border-green-500">
                    </div>
                `).join('');
            }

            const teamSettings = document.getElementById('team-division-settings');
            const teamsCount = parseInt(appData.settings.teamsCount);
            teamSettings.innerHTML = appData.settings.teamConfigs.slice(0, teamsCount).map(t => `
                <div class="flex items-center gap-2 bg-slate-900/50 p-2 rounded-xl border border-white/5">
                    <span class="text-[10px] font-black text-slate-500 w-4">${t.id + 1}</span>
                    <input type="text" value="${t.name}" onchange="updateTeamConfig(${t.id}, 'name', this.value)" class="flex-grow bg-slate-800 border-none rounded-lg px-3 py-1.5 text-xs outline-none focus:ring-1 focus:ring-green-500">
                    <select onchange="updateTeamConfig(${t.id}, 'division', this.value)" class="bg-slate-800 border-none rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none">
                        <option value="East" ${t.division === 'East' ? 'selected' : ''}>East</option>
                        <option value="West" ${t.division === 'West' ? 'selected' : ''}>West</option>
                        <option value="North" ${t.division === 'North' ? 'selected' : ''}>North</option>
                        <option value="South" ${t.division === 'South' ? 'selected' : ''}>South</option>
                    </select>
                </div>
            `).join('');
        }

        function toggleAuctionSettings() {
            const type = document.getElementById('setting-draft-type').value;
            const budgetWrap = document.getElementById('auction-budget-wrap');
            if(budgetWrap) budgetWrap.style.display = type === 'auction' ? 'flex' : 'none';
        }

        function updateProgress(percent, text) {
            const bar = document.getElementById('progress-bar');
            const txt = document.getElementById('loading-text');
            if(bar) bar.style.width = `${percent}%`;
            if(txt) txt.textContent = text;
        }

        function showToast(msg, icon = "‚úÖ") {
            const toast = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            document.getElementById('toast-icon').textContent = icon;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }

        async function fetchNews() {
            try {
                const res = await fetch(NEWS_URL);
                const data = await res.json();
                appData.news = data.articles || [];
            } catch (e) { appData.news = []; }
        }

        window.onload = init;
    </script>
</body>
</html>
