<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Diamond | MLB League Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ef4444;
            --primary-hover: #dc2626;
            --bg-dark: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --border-color: rgba(255, 255, 255, 0.08);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f8fafc; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, h3, .font-heading { font-family: 'Outfit', sans-serif; }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
        }

        .nav-btn {
            transition: all 0.2s ease;
            position: relative;
        }
        .nav-btn.active {
            color: var(--primary);
        }
        .nav-btn.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--primary);
            border-radius: 2px;
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .draft-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .draft-item:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.39);
        }
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.23);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto w-full flex flex-col gap-8 min-h-screen">
        
        <header class="flex flex-col md:flex-row items-center justify-between gap-6 shrink-0">
            <div class="flex items-center gap-4 cursor-pointer" onclick="switchTab('dashboard')">
                <div class="w-14 h-14 bg-red-600 rounded-2xl flex items-center justify-center text-white font-black text-3xl italic shadow-lg shadow-red-900/20">
                    âš¾
                </div>
                <div>
                    <h1 class="text-3xl font-black uppercase tracking-tighter italic leading-none">Fantasy Diamond</h1>
                    <p class="text-[10px] text-red-400 font-bold uppercase tracking-[0.2em] mt-1">MLB League Management â€¢ Mock Drafts â€¢ Analytics</p>
                </div>
            </div>

            <nav class="flex flex-wrap bg-slate-800/50 backdrop-blur-md p-1.5 rounded-2xl border border-white/5 gap-1">
                <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn active px-4 py-2 rounded-xl text-[10px] font-black uppercase">Home</button>
                <button onclick="switchTab('prospects')" id="nav-prospects" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Prospects</button>
                <button onclick="switchTab('draft')" id="nav-draft" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Mock Draft</button>
                <button onclick="switchTab('rosters')" id="nav-rosters" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Database</button>
                <button onclick="switchTab('news')" id="nav-news" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">News</button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase">Settings</button>
            </nav>
        </header>

        <div id="init-loader" class="flex-grow flex flex-col items-center justify-center gap-6 py-20">
            <div class="relative">
                <div class="loader w-16 h-16 border-4"></div>
                <div class="absolute inset-0 flex items-center justify-center text-xl">âš¾</div>
            </div>
            <div class="text-center">
                <p id="loading-text" class="text-sm font-black text-white uppercase tracking-widest">Scouting the Ballpark...</p>
                <div class="w-64 bg-slate-800 rounded-full h-1.5 mt-4 overflow-hidden">
                    <div id="progress-bar" class="bg-red-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Home View -->
        <main id="view-dashboard" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="glass-panel p-8">
                <h2 class="text-2xl font-black uppercase italic mb-6">League Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="stat-card p-6 rounded-2xl">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Active MLB Players</span>
                        <div class="text-3xl font-black mt-1" id="stat-players">0</div>
                    </div>
                    <div class="stat-card p-6 rounded-2xl">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Major League Teams</span>
                        <div class="text-3xl font-black mt-1" id="stat-teams">0</div>
                    </div>
                    <div class="stat-card p-6 rounded-2xl">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Live Sync</span>
                        <div class="text-lg font-black mt-1 text-red-500">Active</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Prospects View -->
        <main id="view-prospects" class="hidden animate-fade-in flex flex-col gap-6 overflow-hidden h-full">
            <div class="shrink-0">
                <h2 class="text-3xl font-black uppercase italic">Top 50 Prospects <span class="text-red-500 font-black">By Position</span></h2>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Season Stat Leaders â€¢ 2024 Campaign</p>
            </div>
            <div id="prospects-grid" class="flex gap-4 overflow-x-auto flex-grow custom-scrollbar pb-4 min-h-0"></div>
        </main>

        <!-- News View -->
        <main id="view-news" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="glass-panel p-8">
                <h2 class="text-3xl font-black uppercase italic mb-8 underline decoration-red-500 underline-offset-8">MLB Pulse <span class="text-sm font-bold text-slate-500 ml-4">Bullpen Updates</span></h2>
                <div id="news-feed-full" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </main>

        <!-- Draft View -->
        <main id="view-draft" class="hidden animate-fade-in flex flex-col gap-6 h-full">
            <div class="glass-panel p-4 flex flex-col sm:flex-row items-center justify-between gap-4 shrink-0">
                <div class="flex items-center gap-6">
                    <div class="flex gap-2">
                        <button id="btn-start-draft" onclick="initiateDraft()" class="btn-primary px-8 py-3 rounded-xl text-sm">Start Mock Draft</button>
                        <button id="btn-pause-draft" onclick="togglePauseDraft()" style="display:none" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl text-sm font-black uppercase transition">Pause</button>
                        <button id="btn-restart-draft" onclick="restartDraft()" style="display:none" class="bg-red-600/20 hover:bg-red-600 text-red-500 hover:text-white px-6 py-3 rounded-xl text-sm font-black uppercase transition border border-red-500/30">Restart</button>
                    </div>
                    <div id="draft-status-indicator" class="flex items-center gap-3">
                        <span id="draft-clock" class="text-2xl font-mono font-black text-slate-500">01:30</span>
                        <div class="h-8 w-px bg-white/10"></div>
                        <div class="flex flex-col">
                            <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Current Pick</span>
                            <span id="current-pick-display" class="text-xs font-bold text-white">Not Started</span>
                        </div>
                    </div>
                </div>
                <button onclick="toggleDraftLog()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded-lg text-[10px] font-black uppercase transition">Selection Log</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full min-h-[700px]">
                <div class="lg:col-span-1 glass-panel p-6 flex flex-col gap-6 overflow-hidden">
                    <h2 class="text-xl font-black uppercase italic">Draft Board</h2>
                    <div id="draft-order" class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow pr-1"></div>
                </div>

                <div class="lg:col-span-2 glass-panel p-4 md:p-6 flex flex-col gap-4 md:gap-6">
                    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                        <h2 class="text-xl font-black uppercase italic text-red-500">Available Players</h2>
                        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <select id="draft-sort" onchange="filterDraftPool()" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-[10px] font-black uppercase focus:outline-none focus:border-red-500">
                                <option value="stats-cur">2024 Stats</option>
                                <option value="career">Career Stats</option>
                                <option value="exp">Experience</option>
                            </select>
                            <input type="text" id="draft-search" oninput="filterDraftPool()" placeholder="Search..." class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-xs outline-none focus:border-red-500">
                        </div>
                    </div>

                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setDraftFilter('ALL')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-red-600 text-white shrink-0">All</button>
                        <button onclick="setDraftFilter('Infielder')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">Infield</button>
                        <button onclick="setDraftFilter('Outfielder')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">Outfield</button>
                        <button onclick="setDraftFilter('Catcher')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">Catcher</button>
                        <button onclick="setDraftFilter('Pitcher')" class="draft-filter-btn px-4 py-2 rounded-xl text-[10px] font-black uppercase bg-slate-800 text-slate-400 shrink-0">Pitcher</button>
                    </div>

                    <div id="draft-pool" class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow pr-1"></div>
                </div>

                <div class="lg:col-span-1 glass-panel p-6 flex flex-col gap-6">
                    <div class="flex flex-col gap-2">
                        <h2 class="text-xl font-black uppercase italic">Team Roster</h2>
                        <select id="roster-view-selector" onchange="renderDraftRoom()" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-[10px] font-black uppercase focus:outline-none focus:border-red-500"></select>
                    </div>
                    <div id="my-draft-roster" class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow"></div>
                </div>
            </div>

            <div id="draft-log-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[2000] hidden flex-col items-center justify-center p-8">
                <div class="glass-panel w-full max-w-2xl max-h-[80vh] flex flex-col p-8 gap-6 border-white/10">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-black uppercase italic">Selection Log</h2>
                        <button onclick="toggleDraftLog()" class="text-3xl text-slate-500 hover:text-white">&times;</button>
                    </div>
                    <div id="draft-log-content" class="flex-grow overflow-y-auto custom-scrollbar pr-4 space-y-2"></div>
                </div>
            </div>
        </main>

        <!-- Players View -->
        <main id="view-rosters" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="glass-panel p-8">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
                    <h2 class="text-2xl font-black uppercase italic">MLB Player Database</h2>
                    <div class="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                        <input type="text" id="roster-search" oninput="filterRosterPlayers()" placeholder="Search..." class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-red-500 w-full md:w-48">
                        <select id="roster-team-filter" onchange="filterRosterPlayers()" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none">
                            <option value="ALL">All Teams</option>
                        </select>
                        <select id="roster-pos-filter" onchange="filterRosterPlayers()" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:outline-none">
                            <option value="ALL">All Positions</option>
                            <option value="Infielder">Infielders</option>
                            <option value="Outfielder">Outfielders</option>
                            <option value="Catcher">Catchers</option>
                            <option value="Pitcher">Pitchers</option>
                        </select>
                    </div>
                </div>
                <div id="full-roster-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div class="mt-8 flex justify-center">
                    <button onclick="loadMorePlayers()" id="btn-load-more" class="px-8 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl font-black uppercase text-xs tracking-widest transition">Load More Athletes</button>
                </div>
            </div>
        </main>

        <!-- Settings View -->
        <main id="view-settings" class="hidden animate-fade-in flex flex-col gap-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-panel p-8">
                    <h2 class="text-2xl font-black uppercase italic mb-8">League Configuration</h2>
                    <div class="space-y-6">
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Teams in League</label>
                            <select id="setting-teams" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-red-500">
                                <option value="8">8 Teams</option>
                                <option value="10" selected>10 Teams</option>
                                <option value="12">12 Teams</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Draft Type</label>
                            <select id="setting-draft-type" class="bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-red-500">
                                <option value="snake" selected>Snake Draft</option>
                                <option value="linear">Linear</option>
                                <option value="random">Random Round</option>
                            </select>
                        </div>
                        <div class="pt-4">
                            <h3 class="text-sm font-black text-slate-300 uppercase mb-4">Roster Limits (Max)</h3>
                            <div id="pos-limits" class="grid grid-cols-3 gap-3"></div>
                        </div>
                        <div class="pt-4">
                            <h3 class="text-sm font-black text-slate-300 uppercase mb-4">Starting Roster Slots</h3>
                            <div id="roster-slots" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
                        </div>
                        <div class="pt-8">
                            <h3 class="text-sm font-black text-slate-300 uppercase mb-4">Franchise Management</h3>
                            <div id="team-division-settings" class="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar pr-2"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-8">
                    <h2 class="text-2xl font-black uppercase italic mb-8">Scoring Matrix</h2>
                    <div class="space-y-4 custom-scrollbar max-h-[1000px] overflow-y-auto pr-2">
                        <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <h4 class="text-xs font-black text-red-400 uppercase mb-3">Batter Stats</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Run</span><input type="number" step="0.5" id="score-r" value="1" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">RBI</span><input type="number" step="0.5" id="score-rbi" value="1" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Home Run</span><input type="number" step="0.5" id="score-hr" value="4" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">SB</span><input type="number" step="0.5" id="score-sb" value="2" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-900/50 rounded-xl border border-white/5">
                            <h4 class="text-xs font-black text-blue-400 uppercase mb-3">Pitcher Stats</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Win</span><input type="number" step="0.5" id="score-win" value="5" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Strikeout</span><input type="number" step="0.5" id="score-k" value="1" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                                <div class="flex justify-between items-center"><span class="text-xs text-slate-300">Save</span><input type="number" step="0.5" id="score-sv" value="5" class="w-16 bg-slate-800 border-none rounded p-1 text-center text-xs"></div>
                            </div>
                        </div>
                    </div>
                    <button onclick="saveSettings()" class="w-full mt-8 btn-primary py-4 rounded-xl">Save All Configurations</button>
                </div>
            </div>
        </main>

        <footer class="mt-auto py-12 border-t border-white/5 flex flex-col md:flex-row items-center justify-between gap-6 text-slate-600">
            <div class="flex items-center gap-3">
                <span class="text-2xl">âš¾</span>
                <span class="text-xs font-black uppercase tracking-widest">Fantasy Diamond v1.0.0</span>
            </div>
            <p class="text-[10px] uppercase font-bold text-center">Data provided by ESPN V2 API â€¢ Build for Kevin Keegan</p>
        </footer>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 z-50 transform translate-y-20 opacity-0 transition-all duration-300">
        <div class="bg-red-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 font-black uppercase text-xs">
            <span id="toast-icon">âœ…</span>
            <span id="toast-msg">Settings Saved</span>
        </div>
    </div>

    <script>
        const API_BASE = "https://site.api.espn.com/apis/site/v2/sports/baseball/mlb";
        const TEAMS_URL = `${API_BASE}/teams`;
        const ROSTER_URL = (id) => `${API_BASE}/teams/${id}/roster`;
        const NEWS_URL = `${API_BASE}/news`;

        let appData = {
            teams: [], players: [], news: [], currentTab: 'dashboard',
            settings: {
                teamsCount: 10, draftType: 'snake', leagueMode: 'standard',
                posLimits: { Infielder: 10, Outfielder: 8, Catcher: 2, Pitcher: 12 },
                rosterPositions: { Catcher: 1, Infielder: 4, Outfielder: 3, Pitcher: 9, BENCH: 5 },
                scoring: { r: 1, rbi: 1, hr: 4, sb: 2, win: 5, k: 1, sv: 5 }
            },
            draft: { active: false, paused: false, currentPick: 1, round: 1, teams: [], availablePlayers: [], filter: 'ALL', log: [], pickOrders: [] }
        };

        async function init() {
            try {
                updateProgress(10, "Gathering MLB Rosters...");
                const teamsRes = await fetch(TEAMS_URL);
                const teamsData = await teamsRes.json();
                appData.teams = teamsData.sports[0].leagues[0].teams.map(t => t.team);
                
                if (appData.settings.teamConfigs === undefined) {
                    appData.settings.teamConfigs = [];
                    for (let i = 0; i < 16; i++) {
                        appData.settings.teamConfigs.push({ id: i, name: i === 0 ? "My Home Runners" : `Rival ${i}`, division: i < 8 ? "East" : "West" });
                    }
                }

                await fetchAllRosters();
                await fetchNews();
                setupUI();
                updateProgress(100, "Play Ball!");
            } catch (err) { console.error(err); }
        }

        async function fetchAllRosters() {
            const teamIds = appData.teams.map(t => t.id);
            await Promise.all(teamIds.map(async (id) => {
                try {
                    const res = await fetch(ROSTER_URL(id));
                    const data = await res.json();
                    const team = appData.teams.find(t => t.id === id);
                    data.athletes.forEach(group => {
                        group.items.forEach(p => {
                            p.teamAbbr = team.abbreviation;
                            p.teamLogo = team.logos[0].href;
                            const rawPos = p.position.abbreviation;
                            if (['1B', '2B', '3B', 'SS', 'IF'].includes(rawPos)) p.posGroup = 'Infielder';
                            else if (['LF', 'CF', 'RF', 'OF'].includes(rawPos)) p.posGroup = 'Outfielder';
                            else if (['C'].includes(rawPos)) p.posGroup = 'Catcher';
                            else if (['P', 'SP', 'RP'].includes(rawPos)) p.posGroup = 'Pitcher';
                            else p.posGroup = 'Other';

                            p.stats2025 = { r: 0, rbi: 0, hr: 0, sb: 0, win: 0, k: 0, sv: 0, points: 0 };
                            p.careerStats = { r: 0, rbi: 0, hr: 0, sb: 0, win: 0, k: 0, sv: 0, points: 0 };
                            appData.players.push(p);
                        });
                    });
                } catch (e) {}
            }));
            appData.players = appData.players.filter(p => p.posGroup !== 'Other');
            renderDashboard();
            document.getElementById('init-loader').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            await deepStatSync();
        }

        async function deepStatSync() {
            const batchSize = 100;
            const total = appData.players.length;
            const syncToast = document.createElement('div');
            syncToast.id = "sync-toast";
            syncToast.className = "fixed bottom-24 right-8 z-50 bg-slate-800 border border-slate-700 px-4 py-2 rounded-xl text-[10px] font-black uppercase flex items-center gap-3 shadow-2xl";
            syncToast.innerHTML = `<span>ðŸ”„</span> <span id="sync-count">Syncing Stats: 0/${total}</span>`;
            document.body.appendChild(syncToast);

            for (let i = 0; i < total; i += batchSize) {
                const batch = appData.players.slice(i, i + batchSize);
                await Promise.all(batch.map(p => fetchRealAthleteStats(p)));
                const el = document.getElementById('sync-count');
                if(el) el.textContent = `Syncing Stats: ${Math.min(i + batchSize, total)}/${total}`;
                if (appData.currentTab === 'dashboard') renderDashboard();
                if (appData.currentTab === 'prospects') renderProspects();
                if (appData.currentTab === 'rosters') filterRosterPlayers();
                if (appData.currentTab === 'draft') filterDraftPool();
            }
            setTimeout(() => { if(document.getElementById('sync-toast')) document.getElementById('sync-toast').remove(); }, 2000);
        }

        async function fetchRealAthleteStats(player) {
            const S_URL = `https://sports.core.api.espn.com/v2/sports/baseball/leagues/mlb/seasons/2024/types/2/athletes/${player.id}/statistics`;
            const C_URL = `https://sports.core.api.espn.com/v2/sports/baseball/leagues/mlb/athletes/${player.id}/statistics`;
            try {
                const [rS, rC] = await Promise.all([fetch(S_URL).then(r=>r.ok?r.json():null), fetch(C_URL).then(r=>r.ok?r.json():null)]);
                const parse = (d) => {
                    if (!d) return null;
                    let cats = d.categories || (d.splits && d.splits.categories);
                    if (!cats) return null;
                    const s = { r: 0, rbi: 0, hr: 0, sb: 0, win: 0, k: 0, sv: 0 };
                    cats.forEach(c => {
                        if (!c.stats) return;
                        c.stats.forEach(st => {
                            const n = st.name; const v = parseFloat(st.value) || 0;
                            if (n === 'runs') s.r = v; if (n === 'runsBattedIn') s.rbi = v;
                            if (n === 'homeRuns') s.hr = v; if (n === 'stolenBases') s.sb = v;
                            if (n === 'wins') s.win = v; if (n === 'strikeouts') s.k = v; if (n === 'saves') s.sv = v;
                        });
                    });
                    return s;
                };
                const realS = parse(rS); const realC = parse(rC);
                if (realS) { player.stats2025 = realS; player.stats2025.points = calculateFantasyPoints(player.stats2025, player.posGroup); }
                if (realC) { player.careerStats = realC; player.careerStats.points = calculateFantasyPoints(player.careerStats, player.posGroup); }
            } catch (e) {}
        }

        function calculateFantasyPoints(stats, pos) {
            const s = appData.settings.scoring;
            let pts = 0;
            if (pos === 'Pitcher') {
                pts += (stats.win * s.win); pts += (stats.k * s.k); pts += (stats.sv * s.sv);
            } else {
                pts += (stats.r * s.r); pts += (stats.rbi * s.rbi); pts += (stats.hr * s.hr); pts += (stats.sb * s.sb);
            }
            return Math.round(pts);
        }

        function getStatLine(stats, pos) {
            if (pos === 'Pitcher') return `${Math.round(stats.win)} W â€¢ ${Math.round(stats.k)} K â€¢ ${stats.sv} SV`;
            return `${Math.round(stats.hr)} HR â€¢ ${Math.round(stats.rbi)} RBI â€¢ ${Math.round(stats.sb)} SB`;
        }

        function switchTab(tab) {
            document.querySelectorAll('main').forEach(m => m.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            appData.currentTab = tab;
            const v = document.getElementById(`view-${tab}`); if (v) v.classList.remove('hidden');
            const n = document.getElementById(`nav-${tab}`); if (n) n.classList.add('active');
            if(tab === 'dashboard') renderDashboard(); if(tab === 'prospects') renderProspects();
            if(tab === 'rosters') renderRosters(); if(tab === 'draft') renderDraftRoom(); if(tab === 'news') renderNews();
        }

        function renderDashboard() {
            document.getElementById('stat-players').textContent = appData.players.length.toLocaleString();
            document.getElementById('stat-teams').textContent = appData.teams.length;
        }

        function renderProspects() {
            const groups = ['Infielder', 'Outfielder', 'Catcher', 'Pitcher'];
            const grid = document.getElementById('prospects-grid'); if (!grid) return;
            grid.innerHTML = groups.map(group => {
                const filtered = appData.players.filter(p => p.posGroup === group).sort((a, b) => b.stats2025.points - a.stats2025.points).slice(0, 50);
                return `<div class="flex flex-col gap-4 bg-slate-900/30 p-4 rounded-2xl border border-white/5 min-w-[320px] shrink-0">
                    <div class="flex items-center justify-between border-b border-white/10 pb-2">
                        <h3 class="text-xl font-black italic text-red-500">${group}s</h3>
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Top 50</span>
                    </div>
                    <div class="flex flex-col gap-2 overflow-y-auto custom-scrollbar flex-grow pr-1">
                        ${filtered.map((p, idx) => `<div class="flex items-center gap-3 p-2 bg-slate-800/40 rounded-xl hover:bg-slate-800 transition border border-transparent hover:border-red-500/30 shrink-0">
                            <span class="text-[10px] font-black text-slate-600 w-4 shrink-0">${idx + 1}</span>
                            <div class="relative shrink-0"><img src="${p.headshot?.href || 'https://a.espncdn.com/i/headshots/full/0.png'}" class="w-8 h-8 rounded-lg bg-slate-900 border border-slate-700"><img src="${p.teamLogo}" class="absolute -bottom-1 -right-1 w-3 h-3"></div>
                            <div class="min-w-0 flex-grow">
                                <div class="text-[10px] font-black uppercase text-white truncate">${p.displayName}</div>
                                <div class="text-[8px] font-bold text-red-500 uppercase">${p.stats2025.points} PTS â€¢ ${p.teamAbbr}</div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        function renderNews() {
            const container = document.getElementById('news-feed-full'); if (!container) return;
            container.innerHTML = appData.news.map(item => `<div onclick="window.open('${item.links?.web?.href || '#'}', '_blank')" class="glass-panel p-6 flex flex-col gap-4 hover:border-red-500/50 transition cursor-pointer group">
                ${item.images && item.images[0] ? `<img src="${item.images[0].url}" class="w-full h-40 object-cover rounded-xl border border-white/5">` : ''}
                <div><h4 class="text-sm font-black uppercase group-hover:text-red-400 transition">${item.headline}</h4></div>
            </div>`).join('');
        }

        function renderDraftRoom() {
            const teamsCount = parseInt(appData.settings.teamsCount);
            const startBtn = document.getElementById('btn-start-draft');
            if (appData.draft.active) { if (startBtn) startBtn.style.display = 'none'; } else {
                if (startBtn) startBtn.style.display = 'block';
                if (appData.draft.teams.length === 0 || appData.draft.teams.length !== teamsCount) {
                    appData.draft.availablePlayers = [...appData.players].sort((a,b) => b.stats2025.points - a.stats2025.points);
                    appData.draft.teams = appData.settings.teamConfigs.slice(0, teamsCount).map(t => ({ id: t.id, name: t.name, roster: [], posCounts: { Infielder: 0, Outfielder: 0, Catcher: 0, Pitcher: 0, BENCH: 0 } }));
                    appData.draft.currentPick = 1; appData.draft.log = [];
                }
                const selector = document.getElementById('roster-view-selector');
                if(selector) selector.innerHTML = appData.draft.teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
            const selectedId = parseInt(document.getElementById('roster-view-selector')?.value || 0);
            const team = appData.draft.teams[selectedId] || { roster: [] };
            const currentRoster = [];
            Object.entries(appData.settings.rosterPositions).forEach(([pos, count]) => { for(let i=0; i<count; i++) currentRoster.push({ pos, player: null }); });
            team.roster.forEach(p => {
                const slot = currentRoster.find(s => s.pos === p.posGroup && !s.player);
                if(slot) slot.player = p;
                else {
                    const benchSlot = currentRoster.find(s => s.pos === 'BENCH' && !s.player);
                    if(benchSlot) benchSlot.player = p;
                }
            });
            document.getElementById('my-draft-roster').innerHTML = currentRoster.map(s => `<div class="p-3 bg-slate-900/50 rounded-xl border ${s.player ? 'border-red-500/30 bg-red-900/10' : 'border-dashed border-slate-700'} flex items-center justify-between transition-all">
                <div class="flex items-center gap-3"><span class="text-[10px] font-black text-slate-500 uppercase w-8">${s.pos}</span>${s.player ? `<img src="${s.player.headshot?.href}" class="w-6 h-6 bg-slate-800 rounded"><span class="text-xs font-black text-white uppercase truncate w-24 sm:w-auto">${s.player.displayName}</span>` : '<span class="text-[10px] italic text-slate-600">Empty</span>'}</div>
            </div>`).join('');
            const order = document.getElementById('draft-order');
            order.innerHTML = appData.draft.teams.map((t, i) => {
                const isCurrent = getTurnIndex(appData.draft.currentPick, teamsCount) === i;
                if (isCurrent) document.getElementById('current-pick-display').textContent = `Pick ${appData.draft.currentPick}: ${t.name}`;
                return `<div class="p-3 bg-slate-900/30 rounded-xl border ${isCurrent ? 'border-red-500 bg-red-900/20 shadow-lg' : 'border-white/5'} flex flex-col gap-2 transition-all duration-300">
                    <div class="flex items-center gap-3"><span class="text-xs font-black ${isCurrent ? 'text-red-500' : 'text-slate-500'}">${i + 1}</span><span class="text-xs font-black uppercase ${isCurrent ? 'text-white' : 'text-slate-400'} truncate">${t.name}</span></div>
                    <div class="flex flex-wrap gap-1 mt-1 opacity-60">${Object.entries(t.posCounts).filter(([p, c]) => c > 0).map(([p, c]) => `<span class="bg-slate-800 px-1.5 py-0.5 rounded text-[8px] font-bold">${p}:${c}</span>`).join('')}</div>
                </div>`;
            }).join('');
            filterDraftPool(); renderDraftLog();
        }

        function getTurnIndex(p, n) {
            const type = appData.settings.draftType; const r = Math.ceil(p / n); const s = (p - 1) % n;
            if (type === 'snake') return (r % 2 === 1) ? s : (n - 1 - s);
            return s;
        }

        function initiateDraft() {
            if (appData.draft.active) return;
            appData.draft.active = true; appData.draft.paused = false;
            document.getElementById('btn-start-draft').style.display = 'none';
            document.getElementById('btn-pause-draft').style.display = 'block';
            document.getElementById('btn-restart-draft').style.display = 'block';
            startDraftClock(); renderDraftRoom();
        }

        function startDraftClock() {
            if (draftClockInterval) clearInterval(draftClockInterval);
            let s = 90; const el = document.getElementById('draft-clock');
            draftClockInterval = setInterval(() => {
                if (!appData.draft.active || appData.draft.paused) return;
                s--; if (s < 0) s = 90;
                const m = Math.floor(s / 60); const sc = s % 60;
                el.textContent = `${String(m).padStart(2, '0')}:${String(sc).padStart(2, '0')}`;
                if (s < 15) el.style.color = '#ef4444'; else el.style.color = '';
            }, 1000);
        }

        function togglePauseDraft() {
            appData.draft.paused = !appData.draft.paused;
            const b = document.getElementById('btn-pause-draft'); b.textContent = appData.draft.paused ? "Resume" : "Pause";
            if (!appData.draft.paused) simulateCPUPicks();
        }

        function restartDraft() {
            if (confirm("Restart?")) {
                appData.draft.active = false; appData.draft.teams = []; appData.draft.currentPick = 1; appData.draft.log = [];
                if (draftClockInterval) clearInterval(draftClockInterval);
                document.getElementById('btn-start-draft').style.display = 'block';
                document.getElementById('btn-pause-draft').style.display = 'none';
                document.getElementById('btn-restart-draft').style.display = 'none';
                renderDraftRoom();
            }
        }

        function filterDraftPool() {
            const search = document.getElementById('draft-search').value.toLowerCase();
            const pos = appData.draft.filter; const sort = document.getElementById('draft-sort').value;
            let filtered = appData.draft.availablePlayers.filter(p => {
                const ms = p.displayName.toLowerCase().includes(search);
                const mp = pos === 'ALL' || p.posGroup === pos;
                return ms && mp;
            });
            filtered.sort((a, b) => {
                if (sort === 'stats-cur') return b.stats2025.points - a.stats2025.points;
                if (sort === 'career') return b.careerStats.points - a.careerStats.points;
                return (b.experience?.years || 0) - (a.experience?.years || 0);
            });
            const pool = document.getElementById('draft-pool');
            pool.innerHTML = filtered.slice(0, 50).map(p => `<div class="draft-item p-3 glass-panel flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 border-white/5 group relative overflow-hidden">
                <div class="flex items-center gap-3 min-w-0">
                    <div class="relative shrink-0"><img src="${p.headshot?.href || 'https://a.espncdn.com/i/headshots/full/0.png'}" class="w-12 h-12 bg-slate-800 rounded-lg border border-slate-700"><img src="${p.teamLogo}" class="absolute -bottom-1 -right-1 w-5 h-5 bg-slate-900 rounded-full border border-slate-700 p-0.5"></div>
                    <div class="min-w-0">
                        <h4 class="text-xs font-black uppercase text-white truncate">${p.displayName}</h4>
                        <div class="flex flex-col"><span class="text-[8px] font-black text-slate-500 uppercase">${p.posGroup} â€¢ ${p.teamAbbr}</span><span class="text-[9px] font-black text-red-400 uppercase">${p.stats2025.points} PTS <span class="text-slate-500 ml-1 font-normal">${getStatLine(p.stats2025, p.posGroup)}</span></span></div>
                    </div>
                </div>
                <button onclick="draftToMyTeam('${p.id}')" class="flex-grow sm:flex-grow-0 px-5 py-2.5 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white rounded-lg text-[10px] font-black uppercase transition-all shadow-sm">Draft</button>
            </div>`).join('');
        }

        function draftToMyTeam(id) {
            const n = parseInt(appData.settings.teamsCount); const idx = getTurnIndex(appData.draft.currentPick, n);
            if (idx !== 0 || !appData.draft.active || appData.draft.paused) return;
            performDraftPick(id, idx); setTimeout(simulateCPUPicks, 1000);
        }

        function performDraftPick(pid, idx) {
            const pi = appData.draft.availablePlayers.findIndex(x => x.id === pid); if (pi === -1) return;
            const p = appData.draft.availablePlayers.splice(pi, 1)[0]; const t = appData.draft.teams[idx];
            t.roster.push(p); t.posCounts[p.posGroup] = (t.posCounts[p.posGroup] || 0) + 1;
            appData.draft.log.unshift({ pick: appData.draft.currentPick, teamName: t.name, player: p });
            appData.draft.currentPick++; renderDraftRoom();
        }

        function simulateCPUPicks() {
            const n = parseInt(appData.settings.teamsCount); let idx = getTurnIndex(appData.draft.currentPick, n);
            if(idx !== 0 && appData.draft.active && !appData.draft.paused && appData.draft.availablePlayers.length > 0) {
                const best = findBestPlayerForTeam(idx); performDraftPick(best.id, idx);
                if(getTurnIndex(appData.draft.currentPick, n) !== 0) setTimeout(simulateCPUPicks, 500);
            }
        }

        function findBestPlayerForTeam(idx) {
            const t = appData.draft.teams[idx]; const lim = appData.settings.posLimits;
            let cand = appData.draft.availablePlayers.filter(p => (t.posCounts[p.posGroup] || 0) < (lim[p.posGroup] || 99));
            return cand[0] || appData.draft.availablePlayers[0];
        }

        function renderDraftLog() {
            const c = document.getElementById('draft-log-content'); if (!c) return;
            c.innerHTML = appData.draft.log.map(e => `<div class="flex items-center gap-4 bg-slate-900/50 p-3 rounded-xl border border-white/5">
                <span class="text-xs font-black text-slate-500 w-8">#${e.pick}</span>
                <div class="flex-grow"><div class="text-[10px] font-black text-slate-400 uppercase">${e.teamName}</div><div class="text-xs font-bold text-white uppercase">${e.player.displayName} <span class="text-slate-500 ml-1">â€¢ ${e.player.posGroup}</span></div></div>
                <img src="${e.player.teamLogo}" class="w-5 h-5 opacity-50">
            </div>`).join('');
        }

        function toggleDraftLog() { document.getElementById('draft-log-overlay').classList.toggle('hidden'); document.getElementById('draft-log-overlay').classList.toggle('flex'); }

        function saveSettings() {
            appData.settings.teamsCount = parseInt(document.getElementById('setting-teams').value);
            appData.settings.draftType = document.getElementById('setting-draft-type').value;
            Object.keys(appData.settings.posLimits).forEach(pos => { const el = document.getElementById(`limit-${pos}`); if (el) appData.settings.posLimits[pos] = parseInt(el.value); });
            appData.draft.active = false; appData.draft.teams = []; setupUI(); switchTab('dashboard'); showToast("Settings Saved");
        }

        function setupUI() {
            const teams = [...new Set(appData.players.map(p => p.teamAbbr))].sort();
            document.getElementById('roster-team-filter').innerHTML = '<option value="ALL">All Teams</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
            document.getElementById('pos-limits').innerHTML = Object.entries(appData.settings.posLimits).map(([pos, count]) => `<div class="flex flex-col gap-1"><span class="text-[9px] font-black text-slate-500 uppercase">${pos} MAX</span><input type="number" value="${count}" id="limit-${pos}" class="bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-center outline-none"></div>`).join('');
            document.getElementById('roster-slots').innerHTML = Object.entries(appData.settings.rosterPositions).map(([pos, count]) => `<div class="flex flex-col gap-1"><span class="text-[9px] font-black text-slate-500 uppercase">${pos}</span><input type="number" value="${count}" class="bg-slate-900 border border-slate-700 rounded-lg p-2 text-xs text-center outline-none"></div>`).join('');
            const tc = appData.settings.teamConfigs.slice(0, appData.settings.teamsCount);
            document.getElementById('team-division-settings').innerHTML = tc.map(t => `<div class="flex items-center gap-2 bg-slate-900/50 p-2 rounded-xl border border-white/5"><span class="text-[10px] font-black text-slate-500 w-4">${t.id + 1}</span><input type="text" value="${t.name}" onchange="updateTeamConfig(${t.id}, 'name', this.value)" class="flex-grow bg-slate-800 border-none rounded-lg px-3 py-1.5 text-xs outline-none"><select onchange="updateTeamConfig(${t.id}, 'division', this.value)" class="bg-slate-800 border-none rounded-lg px-2 py-1.5 text-[10px] font-bold outline-none"><option value="East" ${t.division==='East'?'selected':''}>East</option><option value="West" ${t.division==='West'?'selected':''}>West</option></select></div>`).join('');
        }

        function updateTeamConfig(id, f, v) { const t = appData.settings.teamConfigs.find(x => x.id === id); if (t) t[f] = v; }
        function setDraftFilter(pos) { appData.draft.filter = pos; document.querySelectorAll('.draft-filter-btn').forEach(b => { b.classList.remove('bg-red-600', 'text-white'); b.classList.add('bg-slate-800', 'text-slate-400'); if(b.textContent.includes(pos) || (pos === 'ALL' && b.textContent === 'All')) { b.classList.add('bg-red-600', 'text-white'); b.classList.remove('bg-slate-800', 'text-slate-400'); } }); filterDraftPool(); }
        function updateProgress(p, t) { document.getElementById('progress-bar').style.width = `${p}%`; document.getElementById('loading-text').textContent = t; }
        function showToast(m, i = "âœ…") { const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = m; document.getElementById('toast-icon').textContent = i; t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => { t.classList.add('translate-y-20', 'opacity-0'); }, 3000); }
        async function fetchNews() { try { const res = await fetch(NEWS_URL); const data = await res.json(); appData.news = data.articles || []; } catch (e) { appData.news = []; } }

        window.onload = init;
    </script>
</body>
</html>
