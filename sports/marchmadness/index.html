<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>March Madness Vault | Bracket & Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
        }

        .hover-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hover-card:hover {
            background: rgba(51, 65, 85, 0.9);
            border-color: rgba(249, 115, 22, 0.4);
        }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #f97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Bracket Specific Lines */
        .bracket-line-r {
            position: absolute;
            right: 0;
            top: 50%;
            width: 10px;
            height: 1px;
            background: #475569;
        }
        .bracket-connector-r {
            position: absolute;
            right: -10px;
            width: 10px;
            border-right: 1px solid #475569;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto w-full flex flex-col md:flex-row items-center justify-between gap-6 mb-8 shrink-0">
        <div class="flex items-center gap-4 cursor-pointer" onclick="location.reload()">
            <div class="w-12 h-12 bg-orange-600 rounded-2xl flex items-center justify-center text-white font-black text-2xl shadow-xl shadow-orange-500/20 italic">
                üèÄ
            </div>
            <div>
                <h1 class="text-2xl font-black uppercase tracking-tighter italic">March Madness Vault</h1>
                <p class="text-[10px] text-orange-400 font-bold uppercase tracking-widest">History ‚Ä¢ Live ‚Ä¢ Bracketology</p>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex flex-col sm:flex-row items-center gap-4">
            <!-- Navigation -->
            <div class="flex bg-slate-800 p-1 rounded-xl">
                <button id="nav-history" onclick="switchTab('history')" class="px-4 py-2 rounded-lg text-xs font-black uppercase transition-all bg-orange-600 text-white shadow-lg">
                    Archive
                </button>
                <button id="nav-live" onclick="switchTab('live')" class="px-4 py-2 rounded-lg text-xs font-black uppercase transition-all text-slate-400 hover:text-white">
                    Live Intel
                </button>
                <button id="nav-predict" onclick="switchTab('predict')" class="px-4 py-2 rounded-lg text-xs font-black uppercase transition-all text-slate-400 hover:text-white">
                    Predictor
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-full mx-auto w-full flex-grow relative overflow-hidden flex flex-col">

        <!-- TAB: HISTORY ARCHIVE -->
        <div id="tab-history" class="view-section flex flex-col gap-6 h-full">
            
            <!-- Year Selector & Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                <div class="flex items-center gap-3">
                    <label class="text-xs font-bold text-slate-400 uppercase">Tournament Year:</label>
                    <select id="year-select" onchange="loadTournament(this.value)" class="bg-slate-800 text-white text-xs font-bold uppercase p-2 rounded-lg border border-slate-700 outline-none focus:border-orange-500">
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div id="tournament-summary" class="text-xs font-bold text-slate-300"></div>
            </div>

            <!-- Bracket Container -->
            <div class="glass-panel p-4 overflow-x-auto flex-grow relative min-h-[600px]">
                <div id="bracket-tree" class="flex gap-8 min-w-max p-4">
                    <!-- Rounds injected here -->
                </div>
            </div>
        </div>

        <!-- TAB: LIVE INTEL -->
        <div id="tab-live" class="view-section hidden flex flex-col gap-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Top 25 Rankings -->
                <div class="glass-panel p-6 col-span-1 lg:col-span-2">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black italic uppercase text-white">AP Top 25</h2>
                        <span class="text-[10px] font-bold text-orange-400 uppercase bg-orange-400/10 px-2 py-1 rounded">Live Data</span>
                    </div>
                    <div id="rankings-list" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="col-span-full text-center py-10"><div class="loader mx-auto"></div></div>
                    </div>
                </div>

                <!-- Bubble Watch / Conf Standings (Simplified) -->
                <div class="glass-panel p-6">
                    <h2 class="text-lg font-black italic uppercase text-white mb-6">Power Conferences</h2>
                    <div id="conferences-list" class="flex flex-col gap-2 h-[500px] overflow-y-auto pr-2">
                         <div class="text-center py-10 text-slate-500 text-xs">Loading Standings...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: PREDICTOR -->
        <div id="tab-predict" class="view-section hidden flex flex-col gap-6 h-full">
            <div class="glass-panel p-8 text-center max-w-2xl mx-auto w-full">
                <h2 class="text-3xl font-black italic uppercase text-white mb-2">Bracket Generator</h2>
                <p class="text-slate-400 text-sm mb-8">Create a "Perfect" Bracket using historical probability logic.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <button onclick="generateBracket('chalk')" class="p-4 bg-slate-800 rounded-xl hover:bg-slate-700 border border-slate-700 hover:border-orange-500 transition group text-left">
                        <div class="text-orange-500 font-black uppercase text-sm mb-1">Chalk (Favorites)</div>
                        <p class="text-[10px] text-slate-400">Picks higher seeds. Boring, but historically accurate for early rounds.</p>
                    </button>
                    <button onclick="generateBracket('chaos')" class="p-4 bg-slate-800 rounded-xl hover:bg-slate-700 border border-slate-700 hover:border-red-500 transition group text-left">
                        <div class="text-red-500 font-black uppercase text-sm mb-1">Chaos Mode</div>
                        <p class="text-[10px] text-slate-400">Introduces random upsets based on historical upset probability.</p>
                    </button>
                    <button onclick="generateBracket('weighted')" class="p-4 bg-slate-800 rounded-xl hover:bg-slate-700 border border-slate-700 hover:border-blue-500 transition group text-left">
                        <div class="text-blue-500 font-black uppercase text-sm mb-1">Smart Weighted</div>
                        <p class="text-[10px] text-slate-400">Uses weighted probability. A 16-seed has a 1% chance, etc.</p>
                    </button>
                    <button onclick="generateBracket('random')" class="p-4 bg-slate-800 rounded-xl hover:bg-slate-700 border border-slate-700 hover:border-green-500 transition group text-left">
                        <div class="text-green-500 font-black uppercase text-sm mb-1">Pure Random</div>
                        <p class="text-[10px] text-slate-400">Coin flips for every game. Good luck.</p>
                    </button>
                </div>

                <div id="prediction-result" class="hidden">
                    <div class="bg-slate-900 rounded-xl p-4 border border-white/10">
                        <h3 class="text-white font-bold uppercase text-sm mb-4">Predicted Final Four</h3>
                        <div class="grid grid-cols-2 gap-4" id="predicted-f4"></div>
                        <div class="mt-6 pt-6 border-t border-white/5">
                            <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-2">National Champion</p>
                            <div id="predicted-champ" class="text-2xl font-black text-orange-400 uppercase italic"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Config ---
        const YEAR_START = 1985;
        const YEAR_END = 2025;
        const LIVE_API_RANKINGS = 'https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/rankings';
        const LIVE_API_TEAMS = 'https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/teams?limit=400';

        // --- State ---
        let tournaments = {};
        let currentYearData = null;
        let liveRankings = [];
        let allTeams = [];

        // --- Init ---
        async function init() {
            // Populate Year Selector
            const select = document.getElementById('year-select');
            for (let y = YEAR_END; y >= YEAR_START; y--) {
                if (y === 2020) continue; // Cancelled
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                select.appendChild(opt);
            }

            // Load Default Year (Latest available usually)
            // We try 2024 as a safe default for now if 2025 isn't full
            select.value = 2024;
            loadTournament(2024);

            // Fetch Live Data in background
            fetchLiveData();
        }

        // --- History / Archive Logic ---
        async function loadTournament(year) {
            const container = document.getElementById('bracket-tree');
            const summary = document.getElementById('tournament-summary');
            
            // Basic Loading State
            container.innerHTML = '<div class="m-auto text-slate-500 text-sm font-bold uppercase animate-pulse">Loading Archive...</div>';
            summary.innerHTML = '';

            try {
                let data = tournaments[year];
                if (!data) {
                    const res = await fetch(`json/tournament-${year}.json`);
                    if (!res.ok) throw new Error("Data not found");
                    data = await res.json();
                    tournaments[year] = data;
                }
                
                currentYearData = data;
                renderBracket(data);
                
                if (data.champion) {
                    summary.innerHTML = `üèÜ <span class="text-orange-400">${data.champion}</span> def. ${data.runnerUp}`;
                }

            } catch (e) {
                console.error(e);
                if (window.location.protocol === 'file:') {
                    container.innerHTML = `
                        <div class="m-auto text-center p-6 bg-red-900/20 border border-red-500/50 rounded-xl max-w-md">
                            <h3 class="text-red-500 font-bold uppercase mb-2">Security Restriction</h3>
                            <p class="text-slate-300 text-xs mb-4">
                                Browsers block local data files when opening HTML directly. This is a security feature, not a bug.
                            </p>
                            <div class="bg-black/50 p-3 rounded text-left mb-4">
                                <p class="text-[10px] text-slate-500 uppercase mb-1">To fix, run this command in your folder:</p>
                                <code class="text-green-400 text-xs font-mono select-all">python -m http.server 8000</code>
                            </div>
                            <p class="text-slate-400 text-[10px]">Then open <a href="http://localhost:8000/marchmadness/index.html" class="text-blue-400 underline hover:text-blue-300">http://localhost:8000/marchmadness/index.html</a></p>
                            <p class="text-slate-500 text-[10px] mt-2 italic">Note: This app will work automatically once uploaded to GitHub.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="m-auto text-red-500 text-sm font-bold uppercase">Tournament Data Unavailable</div>';
                }
            }
        }

        function renderBracket(data) {
            const container = document.getElementById('bracket-tree');
            container.innerHTML = '';

            // We need to flatten the structure for a tree view
            // Standard order: R64 -> R32 -> S16 -> E8 -> F4 -> Champ
            const rounds = [
                { id: 'round1', name: 'Round of 64', count: 32 },
                { id: 'round2', name: 'Round of 32', count: 16 },
                { id: 'sweet16', name: 'Sweet 16', count: 8 },
                { id: 'elite8', name: 'Elite 8', count: 4 },
                { id: 'finalFour', name: 'Final 4', count: 2 },
                { id: 'championship', name: 'Champ', count: 1 }
            ];

            rounds.forEach((r, idx) => {
                const col = document.createElement('div');
                col.className = 'flex flex-col justify-around relative';
                col.style.minWidth = '160px'; // Fixed width for cards

                // Header
                const header = document.createElement('div');
                header.className = 'text-center text-[10px] font-bold text-slate-500 uppercase mb-4 absolute -top-8 w-full';
                header.textContent = r.name;
                col.appendChild(header);

                // Games
                let gamesData = [];
                if (r.id === 'championship') {
                    if (data.rounds.championship) gamesData = [data.rounds.championship];
                } else {
                    gamesData = data.rounds[r.id] || [];
                }

                // Fill with empty slots if data missing (bracket builder logic later)
                // For archive, we just show what we have
                gamesData.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'bg-slate-800 border border-slate-700 rounded-lg p-2 text-[10px] mb-2 relative hover:border-orange-500 transition cursor-default shadow-lg';
                    
                    const winner = game.winner;
                    
                    // Team 1
                    const t1Class = winner === game.team1 ? 'text-orange-400 font-bold' : 'text-slate-300';
                    const t2Class = winner === game.team2 ? 'text-orange-400 font-bold' : 'text-slate-300';

                    card.innerHTML = `
                        <div class="flex justify-between mb-1 ${t1Class}">
                            <span class="truncate w-24">${game.seed1 ?? ''} ${game.team1}</span>
                            <span>${game.score1 ?? ''}</span>
                        </div>
                        <div class="flex justify-between ${t2Class}">
                            <span class="truncate w-24">${game.seed2 ?? ''} ${game.team2}</span>
                            <span>${game.score2 ?? ''}</span>
                        </div>
                    `;

                    // Connector Lines (Right side)
                    if (idx < rounds.length - 1) {
                         // This is purely visual CSS logic, simplified for this purpose
                         // Real bracket lines usually require calculating heights dynamically
                         // We will omit complex lines for this "Glass" UI style and rely on column spacing
                    }

                    col.appendChild(card);
                });

                container.appendChild(col);
            });
        }

        // --- Live Data Logic ---
        async function fetchLiveData() {
            try {
                // Fetch Rankings
                const rankRes = await fetch(LIVE_API_RANKINGS);
                const rankData = await rankRes.json();
                
                const rankingsList = document.getElementById('rankings-list');
                rankingsList.innerHTML = '';

                if (rankData.rankings && rankData.rankings.length > 0) {
                    const poll = rankData.rankings[0]; // AP Poll usually first
                    poll.ranks.forEach(r => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-3 bg-slate-800/50 p-3 rounded-xl border border-white/5';
                        div.innerHTML = `
                            <div class="font-black text-xl text-slate-500 w-8 text-center">${r.current}</div>
                            <div class="flex items-center gap-3">
                                <img src="${r.team.logo}" class="w-8 h-8 object-contain">
                                <div>
                                    <div class="text-sm font-bold text-white leading-tight">${r.team.nickname}</div>
                                    <div class="text-[10px] text-slate-400 font-bold uppercase">${r.recordSummary} ‚Ä¢ ${r.points} PTS</div>
                                </div>
                            </div>
                        `;
                        rankingsList.appendChild(div);
                    });
                } else {
                    rankingsList.innerHTML = '<div class="col-span-full text-center text-slate-500">No active rankings available.</div>';
                }

                // Fetch Teams for Conferences (simplified)
                // This might be heavy, so we might skip or limit
                const teamRes = await fetch(LIVE_API_TEAMS);
                const teamData = await teamRes.json();
                // Organize by conference locally or display a few key ones
                // For brevity, we'll just show a "Loaded" message or key teams
                const confList = document.getElementById('conferences-list');
                confList.innerHTML = '';
                
                if (teamData.sports && teamData.sports[0].leagues[0].teams) {
                     allTeams = teamData.sports[0].leagues[0].teams.map(t => t.team);
                     // Display a few random teams as "Active Teams" since API doesn't give standings easily here
                     allTeams.slice(0, 20).forEach(t => {
                         const d = document.createElement('div');
                         d.className = 'flex items-center gap-2 p-2 hover:bg-white/5 rounded transition';
                         d.innerHTML = `
                            <img src="${t.logos[0].href}" class="w-6 h-6">
                            <span class="text-xs text-slate-300 font-bold">${t.displayName}</span>
                         `;
                         confList.appendChild(d);
                     });
                }

            } catch (e) {
                console.error("Live fetch failed", e);
                document.getElementById('rankings-list').innerHTML = '<div class="col-span-full text-center text-red-400 text-xs">Live data unavailable. Check connection.</div>';
            }
        }

        // --- Predictor Logic ---
        function generateBracket(mode) {
            if (!currentYearData || !currentYearData.rounds || !currentYearData.rounds.round1) {
                alert("Please load a historical tournament first to use as a base field.");
                return;
            }

            // Simulation Helper
            const simulateGame = (team1, seed1, team2, seed2) => {
                const s1 = seed1 || 16;
                const s2 = seed2 || 16;

                if (mode === 'chalk') return s1 < s2 ? team1 : team2;
                if (mode === 'random') return Math.random() > 0.5 ? team1 : team2;
                
                if (mode === 'chaos') {
                    const diff = Math.abs(s1 - s2);
                    const upsetChance = 0.3 + (diff * 0.02); 
                    return Math.random() < upsetChance ? (s1 > s2 ? team1 : team2) : (s1 < s2 ? team1 : team2);
                }

                if (mode === 'weighted') {
                    // Standard weighted: Better seed has higher weight
                    // Use inverted seed value (1 -> 16 weight, 16 -> 1 weight)
                    const s1Weight = Math.pow(17 - s1, 1.5); 
                    const s2Weight = Math.pow(17 - s2, 1.5);
                    const total = s1Weight + s2Weight;
                    return Math.random() < (s1Weight / total) ? team1 : team2;
                }
                
                return team1;
            };

            // 1. Initialize Teams from Round 1
            // Round 1 has 32 games. The winners become the 32 teams for Round 2.
            let currentRoundTeams = [];
            
            // The JSON structure is just a list of games, not strictly ordered by bracket region flow usually
            // but usually grouped by region. We will trust the JSON order for simulation flow.
            currentYearData.rounds.round1.forEach(g => {
                const winnerName = simulateGame(g.team1, g.seed1, g.team2, g.seed2);
                const winnerSeed = winnerName === g.team1 ? g.seed1 : g.seed2;
                currentRoundTeams.push({ team: winnerName, seed: winnerSeed });
            });

            // currentRoundTeams now has 32 teams.
            // We simulate rounds until we have 1 team.
            
            const roundHistory = [currentRoundTeams]; // Store history to find F4
            
            while (currentRoundTeams.length > 1) {
                const nextRound = [];
                for (let i = 0; i < currentRoundTeams.length; i += 2) {
                    // Matchup: Team i vs Team i+1
                    // If odd number (shouldn't happen in full bracket), bye
                    if (i + 1 >= currentRoundTeams.length) {
                        nextRound.push(currentRoundTeams[i]);
                        break;
                    }

                    const t1 = currentRoundTeams[i];
                    const t2 = currentRoundTeams[i+1];
                    
                    const winnerName = simulateGame(t1.team, t1.seed, t2.team, t2.seed);
                    const winnerObj = winnerName === t1.team ? t1 : t2;
                    
                    nextRound.push(winnerObj);
                }
                currentRoundTeams = nextRound;
                roundHistory.push(currentRoundTeams);
            }

            const champion = currentRoundTeams[0].team;
            
            // Find Final Four
            // Round History:
            // 0: 32 teams (Winners of R64) -> R32 Field
            // 1: 16 teams (Winners of R32) -> S16 Field
            // 2: 8 teams (Winners of S16) -> E8 Field
            // 3: 4 teams (Winners of E8) -> Final Four Field
            // 4: 2 teams (Winners of F4) -> Championship Field
            // 5: 1 team (Winner)
            
            const f4Field = roundHistory[3] || []; // Should be 4 teams
            
            // Render Result
            const resDiv = document.getElementById('prediction-result');
            const f4Div = document.getElementById('predicted-f4');
            const champDiv = document.getElementById('predicted-champ');

            resDiv.classList.remove('hidden');
            resDiv.scrollIntoView({ behavior: 'smooth' });

            if (f4Field.length === 4) {
                 f4Div.innerHTML = f4Field.map(t => 
                     `<div class="bg-black/20 p-2 rounded text-center text-xs text-slate-300 font-bold">${t.seed} ${t.team}</div>`
                 ).join('');
            } else {
                 f4Div.innerHTML = '<div class="col-span-2 text-center text-xs text-slate-500">Sim error</div>';
            }
            
            champDiv.textContent = champion;
        }

        // --- Tabs ---
        function switchTab(tab) {
            ['history', 'live', 'predict'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                const btn = document.getElementById(`nav-${t}`);
                if (t === tab) {
                    el.classList.remove('hidden');
                    btn.classList.remove('text-slate-400', 'hover:text-white');
                    btn.classList.add('bg-orange-600', 'text-white', 'shadow-lg');
                } else {
                    el.classList.add('hidden');
                    btn.classList.add('text-slate-400', 'hover:text-white');
                    btn.classList.remove('bg-orange-600', 'text-white', 'shadow-lg');
                }
            });
        }

        // Start
        init();

    </script>
</body>
</html>