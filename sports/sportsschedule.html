<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Sports Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #0f172a; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* HEADER */
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e2e8f0;
            z-index: 60;
            flex-shrink: 0;
        }

        /* MAIN LAYOUT */
        #content-area {
            flex: 1;
            overflow: hidden; 
            position: relative;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
        }

        /* --- TABLE STYLING --- */
        .table-view {
            overflow: auto;
            background: white;
            flex: 1;
            border: 1px solid #cbd5e1;
            -webkit-overflow-scrolling: touch; 
            scroll-behavior: smooth;
        }
        
        table {
            border-collapse: separate; 
            border-spacing: 0;
            min-width: 100%;
        }

        th, td {
            padding: 0;
            text-align: center;
            vertical-align: middle;
            background: #fff;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            box-sizing: border-box;
        }

        /* --- STICKY LOGIC --- */
        thead th {
            position: sticky;
            top: 0;
            z-index: 30;
            background: #f8fafc;
            border-bottom: 2px solid #cbd5e1;
        }

        tbody td:first-child, thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 40;
            background: #f8fafc;
            border-right: 2px solid #cbd5e1;
        }

        thead th:first-child {
            z-index: 50; 
            background: #f1f5f9;
        }

        /* Sizing - Standard Mode */
        .mode-standard th { height: 60px; }
        .mode-standard td { height: 70px; }
        .mode-standard td:first-child, .mode-standard th:first-child { min-width: 70px; max-width: 70px; }
        .mode-standard td:not(:first-child) { min-width: 100px; }

        /* Sizing - Flipped Mode */
        .mode-flipped th { height: 50px; }
        .mode-flipped td { height: 60px; }
        /* Clean Left Column: Just Logo */
        .mode-flipped td:first-child, .mode-flipped th:first-child { min-width: 60px; max-width: 60px; padding: 0; } 
        .mode-flipped td:not(:first-child), .mode-flipped th:not(:first-child) { min-width: 100px; }

        /* Game Card Styling */
        .game-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            font-size: 11px;
            padding: 2px;
        }

        .status-scheduled { color: #64748b; font-weight: 600; font-size: 10px; }
        .status-live { color: #ea580c; font-weight: 800; animation: pulse 1.5s infinite; font-size: 11px; }
        .status-win { color: #15803d; font-weight: 800; background: #dcfce7; width: 100%; height: 100%; font-size: 12px; }
        .status-loss { color: #b91c1c; font-weight: 800; background: #fee2e2; width: 100%; height: 100%; font-size: 12px; }
        
        .today-highlight { background-color: #eff6ff !important; }
        .today-highlight-border { border-left: 4px solid #3b82f6 !important; background-color: #eff6ff !important; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="h-14 md:h-16 flex items-center justify-between px-3 md:px-6">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-black text-lg shadow-sm">S</div>
            <h1 class="text-sm md:text-lg font-bold tracking-tight text-slate-800 uppercase hidden sm:block">Master Schedule</h1>
        </div>
        <div class="flex gap-2">
            <!-- Toggle Blank Days -->
            <button onclick="toggleHideEmpty()" id="toggle-empty-btn" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 text-[10px] font-black rounded-lg transition-all shadow-sm uppercase">
                <span id="hide-label">Show All</span>
            </button>
            <button onclick="toggleFlip()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 text-xs font-bold rounded-lg transition-all shadow-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                <span id="flip-btn-text" class="hidden sm:inline">AXIS</span>
            </button>
            <button onclick="openModal()" class="px-3 py-1.5 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 text-xs font-bold rounded-lg transition-all shadow-sm">
                TEAMS
            </button>
            <button id="today-btn" onclick="scrollToToday()" class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold transition-all shadow-sm">
                TODAY
            </button>
        </div>
    </header>

    <div id="content-area">
        <div id="loading" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center">
            <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Syncing Intelligence...</span>
        </div>

        <div id="table-container" class="table-view hidden">
            <table id="main-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="manage-modal" class="hidden modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[85vh] flex flex-col m-4 overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800">Manage Teams</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
            </div>
            
            <div class="p-4 border-b border-slate-100 bg-white">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="search-input" placeholder="Search (e.g. 'Alabama' or 'Duke')" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                    <button onclick="searchTeams()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">Search</button>
                </div>
                <div id="search-results" class="max-h-40 overflow-y-auto space-y-1"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Tracked Teams (Drag to Reorder)</p>
                <ul id="team-list" class="space-y-2"></ul>
            </div>

            <div class="p-4 border-t border-slate-100 flex justify-end gap-2 bg-white">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-500 text-sm font-bold hover:bg-slate-50 rounded-lg">Cancel</button>
                <button onclick="saveAndReload()" class="px-6 py-2 bg-slate-900 text-white text-sm font-bold rounded-lg hover:bg-slate-800 shadow-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_TEAMS = [
            { id: "7", sport: "football", league: "nfl", name: "Broncos", logo: "https://a.espncdn.com/i/teamlogos/nfl/500/den.png" },
            { id: "7", sport: "basketball", league: "nba", name: "Nuggets", logo: "https://a.espncdn.com/i/teamlogos/nba/500/den.png" },
            { id: "21", sport: "hockey", league: "nhl", name: "Avalanche", logo: "https://a.espncdn.com/i/teamlogos/nhl/500/col.png" },
            { id: "27", sport: "baseball", league: "mlb", name: "Rockies", logo: "https://a.espncdn.com/i/teamlogos/mlb/500/col.png" }
        ];

        let TEAMS = JSON.parse(localStorage.getItem('my_sports_teams')) || DEFAULT_TEAMS;
        TEAMS = TEAMS.map(t => { if(t.img && !t.logo) t.logo = t.img; return t; });

        let SCHEDULES = {};
        let IS_FLIPPED = false;
        let SORTED_DATES = [];
        let HIDE_EMPTY = localStorage.getItem('hide_empty') !== null ? JSON.parse(localStorage.getItem('hide_empty')) : true;

        async function init() {
            document.getElementById('loading').classList.remove('hidden');
            const promises = TEAMS.map(fetchSchedule);
            const results = await Promise.all(promises);
            
            SCHEDULES = {};
            TEAMS.forEach((team, index) => {
                SCHEDULES[`${team.id}-${team.league}`] = results[index];
            });

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('table-container').classList.remove('hidden');
            
            updateToggleLabel();
            render();
            // Force scroll to today on load
            setTimeout(scrollToToday, 300);
            setTimeout(scrollToToday, 800);
        }

        async function fetchSchedule(team) {
            try {
                let leaguePath = team.league;
                const url = `https://site.api.espn.com/apis/site/v2/sports/${team.sport}/${leaguePath}/teams/${team.id}/schedule`;
                const res = await fetch(url);
                const data = await res.json();
                const map = {};
                
                if (data.events) {
                    data.events.forEach(ev => {
                        const d = new Date(ev.date);
                        const k = d.toLocaleDateString('en-CA');
                        const comp = ev.competitions?.[0];
                        const us = comp?.competitors?.find(c => c.id === team.id);
                        const them = comp?.competitors?.find(c => c.id !== team.id);
                        const state = ev.status?.type?.state || 'pre';
                        const scoreStr = (us && them) ? `${us.score?.value || 0}-${them.score?.value || 0}` : null;
                        
                        let result = null;
                        if (state === 'post') {
                            const uScore = parseInt(us?.score?.value || 0);
                            const tScore = parseInt(them?.score?.value || 0);
                            if (uScore > tScore) result = 'W';
                            else if (uScore < tScore) result = 'L';
                            else result = 'T';
                        }

                        map[k] = {
                            time: d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}),
                            oppLogo: them?.team?.logos?.[0]?.href,
                            isAway: them?.homeAway === 'home',
                            state: state,
                            score: scoreStr,
                            result: result,
                            network: comp?.broadcasts?.[0]?.media?.shortName
                        };
                    });
                }
                return map;
            } catch (e) { return {}; }
        }

        function render() {
            // 1. Gather all dates that have actual games
            const gameDates = new Set();
            Object.values(SCHEDULES).forEach(s => Object.keys(s).forEach(d => gameDates.add(d)));
            const gameDatesArr = Array.from(gameDates).sort();

            if (gameDatesArr.length === 0) {
                SORTED_DATES = [];
            } else if (HIDE_EMPTY) {
                SORTED_DATES = gameDatesArr;
            } else {
                // Generate FULL RANGE between min and max
                const min = new Date(gameDatesArr[0] + 'T12:00:00');
                const max = new Date(gameDatesArr[gameDatesArr.length - 1] + 'T12:00:00');
                const fullRange = [];
                let curr = new Date(min);
                while (curr <= max) {
                    fullRange.push(curr.toLocaleDateString('en-CA'));
                    curr.setDate(curr.getDate() + 1);
                }
                SORTED_DATES = fullRange;
            }
            
            const today = new Date().toLocaleDateString('en-CA');
            const table = document.getElementById('main-table');
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            
            table.className = IS_FLIPPED ? 'mode-flipped' : 'mode-standard';

            if (!IS_FLIPPED) {
                thead.innerHTML = `
                    <tr>
                        <th style="min-width:70px">DATE</th>
                        ${TEAMS.map(t => `
                            <th>
                                <div class="flex flex-col items-center justify-center">
                                    <img src="${t.logo}" class="w-8 h-8 object-contain">
                                </div>
                            </th>
                        `).join('')}
                    </tr>`;

                tbody.innerHTML = SORTED_DATES.map(date => {
                    const isToday = date === today;
                    const isPast = date < today;
                    const dObj = new Date(date + 'T12:00:00');
                    
                    let html = `<tr class="${isToday ? 'today-highlight' : ''}" id="row-${date}">
                        <td class="${isToday ? 'today-highlight-border' : ''} bg-slate-50">
                            <div class="flex flex-col leading-tight">
                                <span class="text-[8px] font-black text-blue-500 uppercase">${dObj.toLocaleDateString('en-US',{weekday:'short'})}</span>
                                <span class="text-xs font-bold text-slate-800">${dObj.getDate()}</span>
                                <span class="text-[8px] font-bold text-slate-400 uppercase">${dObj.toLocaleDateString('en-US',{month:'short'})}</span>
                            </div>
                        </td>`;
                    
                    TEAMS.forEach(team => {
                        const game = SCHEDULES[`${team.id}-${team.league}`]?.[date];
                        html += renderCell(game, isPast);
                    });
                    return html + '</tr>';
                }).join('');

            } else {
                let headHtml = `<tr><th class="bg-slate-50">TEAM</th>`;
                SORTED_DATES.forEach(date => {
                    const isToday = date === today;
                    const dObj = new Date(date + 'T12:00:00');
                    headHtml += `
                        <th class="${isToday ? 'today-highlight' : ''}" id="col-${date}">
                            <div class="flex flex-col leading-tight">
                                <span class="text-[9px] font-black text-blue-500 uppercase">${dObj.toLocaleDateString('en-US',{weekday:'short'})}</span>
                                <span class="text-xs font-bold text-slate-700">${dObj.getDate()} ${dObj.toLocaleDateString('en-US',{month:'short'})}</span>
                            </div>
                        </th>`;
                });
                thead.innerHTML = headHtml + '</tr>';

                tbody.innerHTML = TEAMS.map(team => {
                    let rowHtml = `<tr>
                        <td class="bg-slate-50">
                            <div class="flex justify-center items-center h-full w-full">
                                <img src="${team.logo}" class="w-8 h-8 object-contain">
                            </div>
                        </td>`;
                    
                    SORTED_DATES.forEach(date => {
                        const game = SCHEDULES[`${team.id}-${team.league}`]?.[date];
                        const isToday = date === today;
                        const isPast = date < today;
                        let cell = renderCell(game, isPast);
                        if(isToday) cell = cell.replace('<td>', '<td class="today-highlight">');
                        rowHtml += cell;
                    });
                    return rowHtml + '</tr>';
                }).join('');
            }
        }

        function renderCell(game, isPast) {
            if (!game) return `<td><span class="text-slate-100 text-lg">.</span></td>`;
            const showScore = game.state === 'in' || game.state === 'post' || isPast;
            const displayValue = showScore ? (game.score || game.time) : game.time;

            let cardClass = '';
            if(game.state === 'in') cardClass = 'status-live';
            else if(game.result === 'W') cardClass = 'status-win';
            else if(game.result === 'L') cardClass = 'status-loss';
            else if(isPast && !game.result) cardClass = 'status-scheduled text-slate-500'; 

            return `<td>
                <div class="game-content ${cardClass}">
                    <div class="flex items-center gap-1 mb-0.5">
                        <span style="font-size:8px;font-weight:700;opacity:0.5">${game.isAway ? '@' : 'vs'}</span>
                        <img src="${game.oppLogo}" class="w-8 h-8 object-contain">
                    </div>
                    <div class="font-black text-xs leading-tight">
                        ${displayValue}
                    </div>
                    ${(game.network && !showScore) ? `<div style="font-size:8px;opacity:0.6;margin-top:1px">${game.network}</div>` : ''}
                </div>
            </td>`;
        }

        function toggleFlip() {
            IS_FLIPPED = !IS_FLIPPED;
            document.getElementById('flip-btn-text').textContent = IS_FLIPPED ? "STANDARD" : "AXIS";
            render();
            scrollToToday();
        }

        function toggleHideEmpty() {
            HIDE_EMPTY = !HIDE_EMPTY;
            localStorage.setItem('hide_empty', HIDE_EMPTY);
            updateToggleLabel();
            render();
            scrollToToday();
        }

        function updateToggleLabel() {
            document.getElementById('hide-label').textContent = HIDE_EMPTY ? "Show All" : "Hide Empty";
        }

        function scrollToToday() {
            const todayStr = new Date().toLocaleDateString('en-CA');
            const container = document.getElementById('table-container');
            
            let targetId = !IS_FLIPPED ? `row-${todayStr}` : `col-${todayStr}`;
            let target = document.getElementById(targetId);
            
            if (!target) {
                const futureDate = SORTED_DATES.find(d => d >= todayStr);
                if (futureDate) {
                    target = document.getElementById(!IS_FLIPPED ? `row-${futureDate}` : `col-${futureDate}`);
                }
            }

            if (target && container) {
                const offset = 80; 
                if (!IS_FLIPPED) {
                    container.scrollTop = target.offsetTop - offset;
                } else {
                    container.scrollLeft = target.offsetLeft - offset;
                }
            }
        }

        // --- MANAGEMENT ---
        function openModal() { document.getElementById('manage-modal').classList.remove('hidden'); renderTeamList(); }
        function closeModal() { document.getElementById('manage-modal').classList.add('hidden'); }
        
        async function searchTeams() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const resBox = document.getElementById('search-results');
            resBox.innerHTML = '<div class="text-xs text-slate-400 text-center p-2">Searching all leagues...</div>';
            
            const sports = [
                'basketball/nba', 'football/nfl', 'baseball/mlb', 'hockey/nhl', 
                'football/college-football', 'basketball/mens-college-basketball',
                'basketball/womens-college-basketball'
            ];
            const hits = [];

            try {
                const promises = sports.map(s => {
                    const limit = s.includes('college') ? '?limit=1000' : '';
                    return fetch(`https://site.api.espn.com/apis/site/v2/sports/${s}/teams${limit}`).then(r => r.json());
                });
                
                const results = await Promise.all(promises);

                results.forEach((d, idx) => {
                    const group = d.sports?.[0]?.leagues?.[0]?.teams || [];
                    const sPath = sports[idx];
                    group.forEach(t => {
                        if (t.team.displayName.toLowerCase().includes(q) || t.team.name.toLowerCase().includes(q)) {
                            hits.push({ 
                                id: t.team.id, 
                                name: t.team.shortDisplayName, 
                                league: sPath.split('/')[1], 
                                sport: sPath.split('/')[0], 
                                logo: t.team.logos[0].href 
                            });
                        }
                    });
                });
                
                resBox.innerHTML = hits.map(t => 
                    `<div class="flex justify-between items-center p-2 border-b hover:bg-slate-50 cursor-pointer" onclick='addTeam(${JSON.stringify(t)})'>
                        <div class="flex items-center gap-2">
                            <img src="${t.logo}" class="w-5 h-5 object-contain">
                            <div class="flex flex-col">
                                <span class="text-sm font-bold text-slate-800">${t.name}</span>
                                <span class="text-[10px] text-slate-400 uppercase">${t.league}</span>
                            </div>
                        </div>
                        <span class="text-blue-600 font-bold text-xs">+ ADD</span>
                    </div>`
                ).join('') || '<div class="text-xs text-slate-400 text-center p-2">No teams found</div>';
            } catch(e) { resBox.innerHTML = 'Search error'; }
        }

        function addTeam(t) {
            if(!TEAMS.find(x => x.id === t.id && x.league === t.league)) TEAMS.push(t);
            renderTeamList();
        }
        function removeTeam(i) {
            TEAMS.splice(i, 1);
            renderTeamList();
        }
        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = TEAMS.map((t, i) => `
                <li class="flex justify-between items-center bg-white p-2 border rounded shadow-sm" draggable="true" data-index="${i}">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-300 cursor-grab">â‰¡</span>
                        <img src="${t.logo}" class="w-6 h-6 object-contain">
                        <span class="text-sm font-bold text-slate-700">${t.name}</span>
                    </div>
                    <button onclick="removeTeam(${i})" class="text-red-500 text-xs font-bold">REMOVE</button>
                </li>
            `).join('');
            
            let dragged = null;
            list.querySelectorAll('li').forEach(li => {
                li.addEventListener('dragstart', () => { dragged = li; li.classList.add('opacity-50'); });
                li.addEventListener('dragend', () => { 
                    dragged.classList.remove('opacity-50'); dragged = null; 
                    TEAMS = [...list.querySelectorAll('li')].map(item => TEAMS[item.dataset.index]);
                    renderTeamList();
                });
                li.addEventListener('dragover', e => {
                    e.preventDefault();
                    const afterElement = [...list.querySelectorAll('li:not(.opacity-50)')].reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = e.clientY - box.top - box.height / 2;
                        return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest;
                    }, { offset: Number.NEGATIVE_INFINITY }).element;
                    if (afterElement == null) list.appendChild(dragged);
                    else list.insertBefore(dragged, afterElement);
                });
            });
        }

        function saveAndReload() {
            localStorage.setItem('my_sports_teams', JSON.stringify(TEAMS));
            location.reload();
        }

        window.onload = init;
    </script>
</body>
</html>