<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
  <title>Gameday Lanes | Pro Sports Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --card: #334155;
      --accent: #3b82f6;
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: #475569;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      line-height: 1.5;
      overflow-x: hidden;
    }

    header {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 10px 0;
    }

    .header-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 0 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header-top { display: flex; align-items: center; justify-content: space-between; }
    .brand {
      font-size: 20px;
      font-weight: 900;
      background: linear-gradient(to right, #60a5fa, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.03em;
    }

    .nav-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .date-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 2px;
      border-radius: 10px;
    }

    .date-nav-btn {
      background: transparent; border: none; color: var(--text); padding: 6px 10px;
      cursor: pointer; border-radius: 6px; transition: all 0.2s; font-weight: 700; font-size: 13px;
    }
    .date-nav-btn:hover { background: var(--card); }

    #dateDisplay { 
      font-size: 13px; font-weight: 800; color: var(--accent); 
      min-width: 110px; text-align: center;
    }
    
    .jump-today {
      font-size: 10px; font-weight: 800;
      background: var(--accent);
      color: white;
      padding: 6px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .sport-tabs {
      display: flex; 
      gap: 8px; 
      overflow-x: auto; 
      padding: 5px 0; 
      scrollbar-width: none;
      -ms-overflow-style: none;
      white-space: nowrap;
      width: 100%;
    }
    .sport-tabs::-webkit-scrollbar { display: none; }

    .sport-tab {
      background: var(--surface); border: 1px solid var(--border); color: var(--muted);
      padding: 6px 14px; border-radius: 99px; cursor: pointer;
      font-size: 11px; font-weight: 700; transition: all 0.2s;
      flex-shrink: 0;
    }
    .sport-tab.active {
      background: var(--accent); color: white; border-color: var(--accent);
    }

    .main-content { padding: 15px; }
    
    .lanes { 
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 20px;
      padding-bottom: 20px;
      scrollbar-width: thin;
      scrollbar-color: var(--card) var(--bg);
    }

    @media (max-width: 767px) {
      .lanes { 
        display: block; 
        overflow-x: visible;
      }
    }

    .lane { 
      width: 320px; 
      flex-shrink: 0; 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    
    @media (max-width: 767px) {
      .lane { width: 100%; }
    }

    .lane-header {
      display: flex; align-items: center; justify-content: space-between; padding-bottom: 8px; border-bottom: 2px solid var(--surface);
    }
    .lane-header h3 { margin: 0; font-size: 14px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }

    .game-card {
      background: var(--surface); border-radius: 16px; padding: 16px;
      border: 1px solid var(--border); box-shadow: var(--shadow); transition: all 0.2s;
      position: relative; cursor: pointer;
    }
    .game-card:hover { border-color: var(--accent); transform: scale(1.01); }
    
    .game-header {
      display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;
    }

    .game-status {
      font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--muted);
    }
    .status-live { color: var(--danger); font-weight: 900; display: flex; align-items: center; gap: 4px; }
    .status-live::before { content: ''; width: 6px; height: 6px; background: var(--danger); border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    .team-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .team-info { display: flex; align-items: center; gap: 10px; }
    
    .team-logo-wrapper {
      width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;
      background: #ffffff; border-radius: 8px; padding: 4px;
    }
    .team-logo { width: 100%; height: 100%; object-fit: contain; }

    .team-name { font-weight: 800; font-size: 14px; display: flex; align-items: center; gap: 6px; }
    .team-meta { font-size: 11px; color: var(--muted); font-weight: 700; }
    .team-score { font-size: 20px; font-weight: 900; }

    .rank-badge {
      font-size: 9px; background: #fbbf24; color: #000; padding: 1px 5px; border-radius: 4px; font-weight: 900;
    }
    .league-rank {
      font-size: 9px; background: var(--accent); color: #fff; padding: 1px 5px; border-radius: 4px; font-weight: 900;
    }

    .win-bar-container { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
    .win-bar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .win-bar-label { font-size: 10px; font-weight: 800; color: var(--muted); text-transform: uppercase; }
    .win-bar { height: 6px; background: var(--card); border-radius: 10px; overflow: hidden; display: flex; }
    .win-bar-fill { 
      height: 100%; background: linear-gradient(90deg, #3b82f6, #a855f7); 
      transition: width 1s ease; 
    }

    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px); z-index: 200; align-items: center; justify-content: center; padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: var(--surface); border-radius: 20px; width: 100%; max-width: 450px;
      padding: 25px; border: 1px solid var(--border);
    }
    
    .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--card); border-radius: 12px; margin-bottom: 8px; }
    .setting-item input { width: 18px; height: 18px; }

    ::-webkit-scrollbar { height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--card); border-radius: 10px; }
  </style>
</head>
<body class="mobile-combined">
  <header>
    <div class="header-container">
      <div class="header-top">
        <div class="brand">GAMEDAY LANES</div>
        <div class="header-actions">
          <button class="action-btn" id="refreshBtn">‚ü≥</button>
          <button class="action-btn" id="settingsBtn">‚öôÔ∏è</button>
        </div>
      </div>
      
      <div class="nav-row">
        <div class="date-wrapper">
          <button class="date-nav-btn" id="prevDate">‚Üê</button>
          <div id="dateDisplay"></div>
          <button class="date-nav-btn" id="nextDate">‚Üí</button>
        </div>
        <button class="jump-today" id="jumpToday">TODAY</button>
      </div>

      <div class="sport-tabs" id="sportTabs">
        <div class="sport-tab active" data-sport="all">All Sports</div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="lanes" id="lanesContainer"></div>
  </main>

  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h3 style="margin-top:0">Settings</h3>
      <label class="setting-item"><span>Show Records</span><input type="checkbox" id="chkRecord" checked></label>
      <label class="setting-item"><span>Show Matchup Quality</span><input type="checkbox" id="chkPct" checked></label>
      <label class="setting-item"><span>Live Games First (Mobile)</span><input type="checkbox" id="chkLiveFirst" checked></label>
      <button class="action-btn" style="width:100%; margin-top:15px; background:var(--accent); border:none; color:white; padding:12px; font-weight:900" onclick="saveSettings()">Save Preferences</button>
    </div>
  </div>

  <script>
    const LANES = [
      {id:'nfl', label:'NFL', league:'football/nfl', core:'nfl', sport:'football', icon:'üèà'},
      {id:'ncaaf', label:'CFB', league:'football/college-football', core:null, sport:'football', icon:'üéì'},
      {id:'nba', label:'NBA', league:'basketball/nba', core:'nba', sport:'basketball', icon:'üèÄ'},
      {id:'wnba', label:'WNBA', league:'basketball/wnba', core:'wnba', sport:'basketball', icon:'üèÄ'},
      {id:'ncaam', label:'CBB(M)', league:'basketball/mens-college-basketball', core:null, sport:'basketball', icon:'üéì'},
      {id:'ncaaw', label:'CBB(W)', league:'basketball/womens-college-basketball', core:null, sport:'basketball', icon:'üéì'},
      {id:'mlb', label:'MLB', league:'baseball/mlb', core:'mlb', sport:'baseball', icon:'‚öæ'},
      {id:'ncaab', label:'C-Base', league:'baseball/college-baseball', core:null, sport:'baseball', icon:'‚öæ'},
      {id:'nhl', label:'NHL', league:'hockey/nhl', core:'nhl', sport:'hockey', icon:'üèí'},
      {id:'soccer', label:'Soccer', league:'soccer/all', icon:'‚öΩ'},
      {id:'golf', label:'Golf', league:'golf/pga', icon:'‚õ≥'},
      {id:'mma', label:'MMA', league:'mma/ufc', icon:'ü•ä'},
      {id:'racing', label:'Race', league:'racing/f1', icon:'üèéÔ∏è'},
      {id:'tennis', label:'Tennis', league:'tennis/atp', icon:'üéæ'}
    ];

    let selectedDate = new Date();
    let isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 767;
    let selectedSports = JSON.parse(localStorage.getItem('gd_selectedSports')) || { nfl:true, nba:true, mlb:true, nhl:true };
    let settings = JSON.parse(localStorage.getItem('gd_settings')) || { record:true, pct:true, liveFirst:true };
    const standingsCache = {};

    function buildTabs() {
      const tabContainer = document.getElementById('sportTabs');
      LANES.forEach(lane => {
        const tab = document.createElement('div');
        tab.className = 'sport-tab' + (selectedSports[lane.id] ? ' active' : '');
        tab.dataset.sport = lane.id;
        tab.innerHTML = `${lane.icon} ${lane.label}`;
        tabContainer.appendChild(tab);
      });
    }

    async function fetchGlobalStandings(lane) {
      if (!lane.core || standingsCache[lane.id]) return;
      try {
        const res = await fetch(`https://site.api.espn.com/apis/v2/sports/${lane.sport}/${lane.core}/standings`);
        const data = await res.json();
        let entries = [];
        const findEntries = (obj) => {
          if (obj.standings && obj.standings.entries) entries.push(...obj.standings.entries);
          if (obj.children) obj.children.forEach(findEntries);
        };
        findEntries(data);
        const teams = entries.map(item => {
          const s = item.stats;
          const wins = s.find(x => x.name === 'wins')?.value || 0;
          const losses = s.find(x => x.name === 'losses')?.value || 0;
          const ties = s.find(x => x.name === 'ties')?.value || 0;
          const total = wins + losses + ties;
          return { id: item.team.id, pct: total > 0 ? wins/total : 0.5 };
        });
        teams.sort((a,b) => b.pct - a.pct);
        const map = {};
        teams.forEach((t, i) => map[t.id] = { rank: i + 1, pct: t.pct });
        standingsCache[lane.id] = map;
      } catch (e) { console.warn(`Standings fetch failed for ${lane.id}`); }
    }

    async function fetchLaneData(lane, dateStr) {
      try {
        let endpoint = `https://site.api.espn.com/apis/site/v2/sports/${lane.league}/scoreboard?dates=${dateStr}`;
        if (lane.id === 'soccer') {
          const leagues = ['usa.1', 'eng.1', 'esp.1'];
          const soccerData = await Promise.all(leagues.map(l => fetch(`https://site.api.espn.com/apis/site/v2/sports/soccer/${l}/scoreboard?dates=${dateStr}`).then(r => r.json())));
          return { lane, games: soccerData.flatMap(d => d.events || []) };
        }
        const res = await fetch(endpoint);
        const data = await res.json();
        return { lane, games: data.events || [] };
      } catch (e) { return { lane, games: [] }; }
    }

    function getTeamData(comp, type, laneId) {
      const t = comp.competitors.find(c => c.homeAway === type);
      const rec = t.records?.find(r => r.type === 'total')?.summary || '0-0';
      const curatedRank = t.curatedRank?.current < 99 ? t.curatedRank.current : null;
      let winPct = 0.5;
      let leagueRank = null;

      if (standingsCache[laneId]?.[t.id]) {
        winPct = standingsCache[laneId][t.id].pct;
        leagueRank = standingsCache[laneId][t.id].rank;
      } else {
        const recArr = rec.split('-').map(Number);
        const total = (recArr[0]||0) + (recArr[1]||0);
        if (total > 0) winPct = recArr[0] / total;
      }

      return {
        id: t.id,
        name: t.team.shortDisplayName || t.team.abbreviation,
        logo: t.team.logo,
        score: t.score || '0',
        record: rec,
        curatedRank: curatedRank,
        leagueRank: leagueRank,
        winPct: winPct
      };
    }

    async function renderDashboard() {
      const container = document.getElementById('lanesContainer');
      const dateDisplay = document.getElementById('dateDisplay');
      dateDisplay.textContent = selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' });
      
      const dateStr = selectedDate.getFullYear() + String(selectedDate.getMonth() + 1).padStart(2, '0') + String(selectedDate.getDate()).padStart(2, '0');
      container.innerHTML = '<div style="flex:1; text-align:center; padding:60px; color:var(--muted); font-weight:800">SYNCING DATA...</div>';

      await Promise.all(LANES.map(l => fetchGlobalStandings(l)));
      const results = await Promise.all(LANES.map(l => fetchLaneData(l, dateStr)));
      container.innerHTML = '';

      if (isMobile) {
        const allGames = [];
        results.forEach(({ lane, games }) => {
          if (!games || !selectedSports[lane.id]) return;
          games.forEach(game => {
            const comp = game.competitions[0];
            const h = getTeamData(comp, 'home', lane.id);
            const a = getTeamData(comp, 'away', lane.id);
            allGames.push({ 
              game, home:h, away:a, lane, 
              quality: (h.winPct + a.winPct) / 2,
              isLive: game.status.type.state === 'in'
            });
          });
        });

        // Toggle Sort: Live First, then by Matchup Quality
        allGames.sort((a,b) => {
          if (settings.liveFirst && a.isLive !== b.isLive) return a.isLive ? -1 : 1;
          return b.quality - a.quality;
        });

        const laneEl = document.createElement('div');
        laneEl.className = 'lane';
        laneEl.innerHTML = `<div class="lane-header"><h3>COMBINED FEED</h3><span style="font-size:11px; font-weight:800; color:var(--accent)">${allGames.length} GAMES</span></div>`;
        allGames.forEach(g => laneEl.appendChild(createCard(g.game, g.home, g.away, g.lane, g.quality)));
        container.appendChild(laneEl);
      } else {
        results.forEach(({ lane, games }) => {
          if (!games || games.length === 0 || !selectedSports[lane.id]) return;
          const laneEl = document.createElement('div');
          laneEl.className = 'lane';
          laneEl.innerHTML = `<div class="lane-header"><h3>${lane.label}</h3><span style="font-size:11px; font-weight:800; color:var(--accent)">${games.length}</span></div>`;
          games.forEach(game => {
            const comp = game.competitions[0];
            const h = getTeamData(comp, 'home', lane.id);
            const a = getTeamData(comp, 'away', lane.id);
            laneEl.appendChild(createCard(game, h, a, lane, (h.winPct + a.winPct) / 2));
          });
          container.appendChild(laneEl);
        });
      }
    }

    function createCard(game, home, away, lane, quality) {
      const state = game.status.type.state;
      const qScore = Math.round(quality * 100);
      const card = document.createElement('div');
      card.className = 'game-card';
      
      const homeRank = home.leagueRank || home.curatedRank;
      const awayRank = away.leagueRank || away.curatedRank;
      const isLeagueRank = !!home.leagueRank;

      card.innerHTML = `
        <div class="game-header">
          <div class="game-status ${state==='in'?'status-live':''}">
            ${state==='in' ? game.status.type.detail : (state==='pre' ? new Date(game.date).toLocaleTimeString([],{hour:'numeric',minute:'2-digit'}) : 'FINAL')}
          </div>
          <div style="font-size:10px; color:var(--accent); font-weight:900">${lane.icon} ${isMobile ? lane.label : ''}</div>
        </div>
        <div class="team-row">
          <div class="team-info">
            <div class="team-logo-wrapper"><img src="${away.logo}" class="team-logo"></div>
            <div class="team-name">
              ${awayRank?`<span class="${isLeagueRank?'league-rank':'rank-badge'}">#${awayRank}</span>`:''}
              ${away.name}
            </div>
          </div>
          <div class="team-score" style="${state==='post' && parseInt(away.score) < parseInt(home.score) ? 'opacity:0.4' : ''}">${away.score}</div>
        </div>
        ${settings.record ? `<div class="team-meta" style="margin-top:-10px; margin-left:48px; margin-bottom:10px;">${away.record}</div>` : ''}
        
        <div class="team-row">
          <div class="team-info">
            <div class="team-logo-wrapper"><img src="${home.logo}" class="team-logo"></div>
            <div class="team-name">
              ${homeRank?`<span class="${isLeagueRank?'league-rank':'rank-badge'}">#${homeRank}</span>`:''}
              ${home.name}
            </div>
          </div>
          <div class="team-score" style="${state==='post' && parseInt(home.score) < parseInt(away.score) ? 'opacity:0.4' : ''}">${home.score}</div>
        </div>
        ${settings.record ? `<div class="team-meta" style="margin-top:-10px; margin-left:48px; margin-bottom:12px;">${home.record}</div>` : ''}

        ${settings.pct ? `
          <div class="win-bar-container">
            <div class="win-bar-header">
              <span class="win-bar-label">Matchup Quality</span>
              <span class="win-bar-label" style="color:var(--accent)">${qScore}%</span>
            </div>
            <div class="win-bar"><div class="win-bar-fill" style="width:${qScore}%"></div></div>
          </div>
        ` : ''}
      `;
      return card;
    }

    document.getElementById('sportTabs').onclick = (e) => {
      const tab = e.target.closest('.sport-tab');
      if (!tab) return;
      const sport = tab.dataset.sport;
      if (sport === 'all') {
        const active = !tab.classList.contains('active');
        LANES.forEach(l => selectedSports[l.id] = active);
        document.querySelectorAll('.sport-tab').forEach(t => t.classList.toggle('active', active));
      } else {
        selectedSports[sport] = !selectedSports[sport];
        tab.classList.toggle('active');
      }
      localStorage.setItem('gd_selectedSports', JSON.stringify(selectedSports));
      renderDashboard();
    };

    document.getElementById('prevDate').onclick = () => { selectedDate.setDate(selectedDate.getDate()-1); renderDashboard(); };
    document.getElementById('nextDate').onclick = () => { selectedDate.setDate(selectedDate.getDate()+1); renderDashboard(); };
    document.getElementById('jumpToday').onclick = () => { selectedDate = new Date(); renderDashboard(); };
    document.getElementById('refreshBtn').onclick = () => location.reload();
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('chkRecord').checked = settings.record;
      document.getElementById('chkPct').checked = settings.pct;
      document.getElementById('chkLiveFirst').checked = settings.liveFirst;
      document.getElementById('settingsModal').classList.add('active');
    };
    
    function saveSettings() {
      settings = { 
        record: document.getElementById('chkRecord').checked, 
        pct: document.getElementById('chkPct').checked,
        liveFirst: document.getElementById('chkLiveFirst').checked
      };
      localStorage.setItem('gd_settings', JSON.stringify(settings));
      document.getElementById('settingsModal').classList.remove('active');
      renderDashboard();
    }

    buildTabs();
    renderDashboard();
    setInterval(renderDashboard, 60000);
  </script>
</body>
</html>
