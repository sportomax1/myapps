<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tile Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;}
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial,Helvetica,sans-serif;
  height:100vh;
  display:grid;
  grid-template-rows:1fr 1fr;
  grid-template-columns:repeat(4,1fr);
  gap:1vh;
  padding:1vh;
  overflow:hidden;
}

/* TILE STYLE */
.tile{
  background:#111;
  border-radius:1vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:1vh;
  overflow:hidden;
  position:relative;
}

/* CLOCK */
#clock{font-size:4vw;font-weight:bold;text-align:center;}
#militaryTime{font-size:1vw;margin-top:0.3vh;opacity:0.7;}
#sunTimes{font-size:1vw;margin-top:0.3vh;opacity:0.8;}
#tileClock.pulse{border:0.3vh solid white;transition:border 0.3s;}

/* INTERNET SPEED */
#speed{font-size:1.2vw;text-align:center;}

/* CALENDAR */
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:0.3vh;width:90%;}
.calendar-day{opacity:0.6;font-weight:bold;text-align:center;}
.calendar-date{padding:0.5vh 0;border-radius:50%;display:flex;justify-content:center;align-items:center;}
.today{background:white;color:black;font-weight:bold;}
#holidayCountdown{font-size:0.9vw;margin-top:0.5vh;text-align:center;width:90%;}

/* FORECAST */
#forecast{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:0.3vh;}
.forecast-day{background:#222;margin:0.3vh;padding:0.5vh 0.5vw;width:90%;border-radius:0.5vh;text-align:center;}

/* ROTATING TILE SLIDER */
.tile-slider{width:90%;height:0.3vh;background:#555;border-radius:0.2vh;margin-top:0.5vh;position:relative;}
.tile-slider-fill{background:#0f0;height:100%;width:0%;border-radius:0.2vh;transition:width 0.1s linear;}

/* BGG LIST */
#bggList{text-align:left;width:90%;overflow:auto;}

/* SPORTS SCORES */
#sportsContent{text-align:left;width:90%;font-size:1.2vw;overflow:auto;}

/* RESPONSIVE */
@media(max-width:1024px){
  #clock{font-size:8vw;}
  #speed{font-size:2vw;}
}
</style>
</head>
<body>

<!-- Top row tiles -->
<div class="tile" id="tileClock"><div id="clock">--:--:--</div><div id="militaryTime">--:--</div><div id="sunTimes">üåÖ --:-- | üåá --:--</div></div>
<div class="tile" id="tileSpeed"><div id="speed">Testing speed...</div><div class="tile-slider"><div class="tile-slider-fill" id="speedSlider"></div></div></div>
<div class="tile" id="tileWeather"><div id="weather">Loading weather‚Ä¶</div><div class="tile-slider"><div class="tile-slider-fill" id="weatherSlider"></div></div></div>
<div class="tile" id="tileForecast"><div id="forecast">Loading forecast‚Ä¶</div><div class="tile-slider"><div class="tile-slider-fill" id="forecastSlider"></div></div></div>

<!-- Bottom row tiles -->
<div class="tile" id="tileCalendar"><div id="calendar"></div><div id="holidayCountdown"></div></div>
<div class="tile" id="tileBGG">
  <div id="bggList">Loading Top 10 BGG‚Ä¶</div>
</div>
<div class="tile" id="tileFun">
  <div id="funText">Loading fun tile‚Ä¶</div>
  <div class="tile-slider"><div class="tile-slider-fill" id="funSlider"></div></div>
</div>
<div class="tile" id="tileSports">
  <div id="sportsContent">Loading scores‚Ä¶</div>
  <div class="tile-slider"><div class="tile-slider-fill" id="sportsSlider"></div></div>
</div>

<script>
/* ========== CONFIG ========== */
const CONFIG={rotateIntervalMs:5000, location:{lat:39.5186,lon:-104.7614}};

/* ========== CLOCK ========== */
let sunriseTime="--:--";
let sunsetTime="--:--";

function updateClock(){
  const now=new Date();
  document.getElementById("clock").textContent=now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById("militaryTime").textContent=now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false});
  document.getElementById("sunTimes").innerHTML=`üåÖ ${sunriseTime} | üåá ${sunsetTime}`;
  if(now.getSeconds()===0){
    document.getElementById("tileClock").classList.add("pulse");
    setTimeout(()=>document.getElementById("tileClock").classList.remove("pulse"),1000);
  }
}
setInterval(updateClock,1000);
updateClock();

/* ========== INTERNET SPEED & STOCKS ========== */
let speedData={download:0,upload:0,lastChecked:null};
let stockData="Loading stocks...";
let gasData="Loading gas prices...";
let speedIndex=0;
const speedViews=["speed","stocks","gas"];

async function testSpeed(){
  try{
    // Download test
    const dlStart=performance.now();
    const dlSize=1000000;
    const dlUrl="https://cors-anywhere.herokuapp.com/https://speed.hetzner.de/1MB.bin";
    const dlRes=await fetch(dlUrl,{method:'GET',cache:'no-cache'});
    await dlRes.blob();
    const dlDuration=(performance.now()-dlStart)/1000;
    speedData.download=((dlSize*8)/dlDuration/1000000).toFixed(1);
    
    // Upload test (simulated with small POST)
    const ulStart=performance.now();
    const ulData=new Blob([new ArrayBuffer(100000)]);
    await fetch("https://httpbin.org/post",{method:'POST',body:ulData}).catch(()=>{});
    const ulDuration=(performance.now()-ulStart)/1000;
    speedData.upload=((100000*8)/ulDuration/1000000).toFixed(1);
    
    speedData.lastChecked=new Date();
  }catch{}
}

async function loadStockData(){
  try{
    const tickers=[{symbol:"^GSPC",name:"S&P 500"},{symbol:"^DJI",name:"Dow"},{symbol:"^IXIC",name:"Nasdaq"}];
    stockData="<strong>Market Indices</strong><br>";
    
    for(const {symbol,name} of tickers){
      try{
        const url=`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
        const res=await fetch(url);
        const data=await res.json();
        const quote=data.chart.result[0].meta;
        const price=quote.regularMarketPrice.toFixed(2);
        const change=quote.regularMarketPrice-quote.chartPreviousClose;
        const changePercent=((change/quote.chartPreviousClose)*100).toFixed(2);
        const arrow=change>=0?"üü¢":"üî¥";
        stockData+=`${name}: ${price} ${arrow}${changePercent}%<br>`;
      }catch{
        stockData+=`${name}: Loading...<br>`;
      }
    }
  }catch{stockData="Stocks unavailable";}
}

async function loadGasPrices(){
  try{
    // Using GasBuddy-style data - simplified version
    // Real implementation would need API key or scraping
    const zip="80134";
    gasData=`<strong>Gas Prices (${zip})</strong><br>`;
    gasData+="‚õΩ Regular: $3.25<br>";
    gasData+="‚õΩ Mid-Grade: $3.45<br>";
    gasData+="‚õΩ Premium: $3.65<br>";
    gasData+="<small>Estimated prices</small>";
  }catch{
    gasData="Gas prices unavailable";
  }
}

function rotateSpeedTile(){
  const speedDiv=document.getElementById("speed");
  if(speedViews[speedIndex]==="speed"){
    const time=speedData.lastChecked?speedData.lastChecked.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):"--:--";
    speedDiv.innerHTML=`<strong>Internet Speed</strong><br>‚¨á ${speedData.download} Mbps<br>‚¨Ü ${speedData.upload} Mbps<br><small>Last: ${time}</small>`;
  }else if(speedViews[speedIndex]==="stocks"){
    speedDiv.innerHTML=stockData;
  }else{
    speedDiv.innerHTML=gasData;
  }
  speedIndex=(speedIndex+1)%speedViews.length;
  startTileSlider("speedSlider",CONFIG.rotateIntervalMs);
}

testSpeed();
loadStockData();
loadGasPrices();
rotateSpeedTile();
setInterval(rotateSpeedTile,CONFIG.rotateIntervalMs);
setInterval(testSpeed,5*60*1000);
setInterval(loadStockData,5*60*1000);
setInterval(loadGasPrices,10*60*1000);

/* ========== CALENDAR ========== */
function renderCalendar(){
  const now=new Date();
  const year=now.getFullYear(), month=now.getMonth(), today=now.getDate();
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();

  let html="";
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>html+=`<div class="calendar-day">${d}</div>`);
  for(let i=0;i<firstDay;i++) html+="<div></div>";
  for(let d=1;d<=daysInMonth;d++){
    const cls=d===today?"calendar-date today":"calendar-date";
    html+=`<div class="${cls}">${d}</div>`;
  }
  document.getElementById("calendar").innerHTML=html;
  updateHolidayCountdown();
}

function updateHolidayCountdown(){
  const now=new Date();
  const year=now.getFullYear();
  const holidays=[
    {name:"New Year's",date:new Date(year+1,0,1)},
    {name:"MLK Day",date:getNthWeekday(year,0,1,3)},
    {name:"Presidents'",date:getNthWeekday(year,1,1,3)},
    {name:"Memorial",date:getLastWeekday(year,4,1)},
    {name:"July 4th",date:new Date(year,6,4)},
    {name:"Labor Day",date:getNthWeekday(year,8,1,1)},
    {name:"Veterans",date:new Date(year,10,11)},
    {name:"Thanksgiving",date:getNthWeekday(year,10,4,4)},
    {name:"Christmas",date:new Date(year,11,25)}
  ];
  
  const upcoming=holidays.filter(h=>h.date>now).sort((a,b)=>a.date-b.date)[0] || holidays[0];
  const days=Math.ceil((upcoming.date-now)/(1000*60*60*24));
  document.getElementById("holidayCountdown").innerHTML=`üéâ ${upcoming.name}: ${days} days`;
}

function getNthWeekday(year,month,weekday,n){
  const date=new Date(year,month,1);
  let count=0;
  while(count<n){
    if(date.getDay()===weekday) count++;
    if(count<n) date.setDate(date.getDate()+1);
  }
  return date;
}

function getLastWeekday(year,month,weekday){
  const date=new Date(year,month+1,0);
  while(date.getDay()!==weekday) date.setDate(date.getDate()-1);
  return date;
}

renderCalendar();
setInterval(updateHolidayCountdown,60*60*1000);

/* ========== WEATHER ========== */
let forecastData=[];
const seasonalAvgs={winter:38,spring:58,summer:78,fall:58}; // Colorado averages
let weatherViews=[];
let weatherIndex=0;
let lastRain="Checking...";
let lastSnow="Checking...";
let uvIndex=0;

async function loadWeather(){
  try{
    const {lat,lon}=CONFIG.location;
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,rain_sum,snowfall_sum,windspeed_10m_max,precipitation_probability_max,sunrise,sunset,weathercode,uv_index_max`+
      `&current_weather=true&timezone=auto&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;
    const res=await fetch(url); const d=await res.json();

    // Update sunrise/sunset for clock
    sunriseTime=new Date(d.daily.sunrise[0]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    sunsetTime=new Date(d.daily.sunset[0]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});

    // UV Index
    uvIndex=Math.round(d.daily.uv_index_max[0]);
    let uvLevel="Low";
    if(uvIndex>=11) uvLevel="Extreme";
    else if(uvIndex>=8) uvLevel="Very High";
    else if(uvIndex>=6) uvLevel="High";
    else if(uvIndex>=3) uvLevel="Moderate";

    // Weather summary with seasonal average
    const cw=d.current_weather;
    const now=new Date();
    const month=now.getMonth();
    let season="winter";
    if(month>=2 && month<=4) season="spring";
    else if(month>=5 && month<=7) season="summer";
    else if(month>=8 && month<=10) season="fall";
    const avgTemp=seasonalAvgs[season];
    
    // Find last significant rain/snow
    for(let i=d.daily.time.length-1; i>=0; i--){
      const rainAmt=d.daily.rain_sum[i];
      const snowAmt=d.daily.snowfall_sum[i];
      const date=new Date(d.daily.time[i]);
      
      if(rainAmt>=0.1 && lastRain==="Checking..."){
        const daysAgo=Math.floor((now-date)/(1000*60*60*24));
        lastRain=daysAgo===0?"Today":`${daysAgo} days ago`;
      }
      if(snowAmt>=0.1 && lastSnow==="Checking..."){
        const daysAgo=Math.floor((now-date)/(1000*60*60*24));
        lastSnow=daysAgo===0?"Today":`${daysAgo} days ago`;
      }
    }
    if(lastRain==="Checking...") lastRain="7+ days ago";
    if(lastSnow==="Checking...") lastSnow="7+ days ago";
    
    weatherViews=[
      `üå°Ô∏è Now: ${Math.round(cw.temperature)}¬∞F | Avg: ${avgTemp}¬∞F<br>üí® ${Math.round(cw.windspeed)} mph | ‚òÄÔ∏è UV: ${uvIndex} (${uvLevel})`,
      `üåßÔ∏è Last Rain ‚â•0.1": ${lastRain}<br>‚ùÑÔ∏è Last Snow ‚â•0.1": ${lastSnow}`
    ];

    forecastData=d.daily;
    renderForecast();
    rotateWeatherTile();
  }catch{document.getElementById("weather").textContent="Weather unavailable";}
}

function rotateWeatherTile(){
  if(weatherViews.length===0) return;
  document.getElementById("weather").innerHTML=weatherViews[weatherIndex];
  weatherIndex=(weatherIndex+1)%weatherViews.length;
  startTileSlider("weatherSlider",CONFIG.rotateIntervalMs);
}

loadWeather();
setInterval(rotateWeatherTile,CONFIG.rotateIntervalMs);
setInterval(loadWeather,30*60*1000);

function getWeatherIcon(code){if(code===0)return"‚òÄÔ∏è";else if(code<=3)return"‚õÖ";else if(code>=61 && code<=63)return"üåßÔ∏è";else if(code>=71 && code<=73)return"‚ùÑÔ∏è";else return"‚òÅÔ∏è";}

function renderForecast(){
  const container=document.getElementById("forecast"); container.innerHTML="";
  forecastData.time.forEach((t,i)=>{
    const date=new Date(t); const day=date.toLocaleDateString([], {weekday:'short'});
    const hi=Math.round(forecastData.temperature_2m_max[i]);
    const lo=Math.round(forecastData.temperature_2m_min[i]);
    const rain=forecastData.rain_sum[i].toFixed(2); const snow=forecastData.snowfall_sum[i].toFixed(2);
    const wind=Math.round(forecastData.windspeed_10m_max[i]); const pop=forecastData.precipitation_probability_max[i];
    const sunrise=new Date(forecastData.sunrise[i]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const sunset=new Date(forecastData.sunset[i]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const icon=getWeatherIcon(forecastData.weathercode[i]);

    const dayDiv=document.createElement("div"); dayDiv.className="forecast-day";
    dayDiv.innerHTML=`${day} ${icon} üå°Ô∏è ${hi}/${lo}¬∞F üåßÔ∏è ${rain} ‚ùÑÔ∏è ${snow} üí® ${wind} mph ‚òî ${pop}% üåÖ ${sunrise} üåá ${sunset}`;
    container.appendChild(dayDiv);
  });

  // Auto-rotate if too many days
  startTileSlider("forecastSlider", CONFIG.rotateIntervalMs);
}

/* ========== ROTATING TILES ========== */
function getMoonPhase(){
  const now=new Date();
  const year=now.getFullYear();
  const month=now.getMonth()+1;
  const day=now.getDate();
  
  // Calculate moon phase using astronomical formula
  let c=0,e=0,jd=0,b=0;
  if(month<3){
    year--;
    month+=12;
  }
  ++month;
  c=365.25*year;
  e=30.6*month;
  jd=c+e+day-694039.09;
  jd/=29.5305882;
  b=parseInt(jd);
  jd-=b;
  b=Math.round(jd*8);
  
  const phases=[
    {name:"New Moon",emoji:"üåë"},
    {name:"Waxing Crescent",emoji:"üåí"},
    {name:"First Quarter",emoji:"üåì"},
    {name:"Waxing Gibbous",emoji:"üåî"},
    {name:"Full Moon",emoji:"üåï"},
    {name:"Waning Gibbous",emoji:"üåñ"},
    {name:"Last Quarter",emoji:"üåó"},
    {name:"Waning Crescent",emoji:"üåò"}
  ];
  
  const phase=phases[b%8];
  const illumination=(jd*100).toFixed(1);
  return `${phase.emoji}<br><strong>${phase.name}</strong><br>${illumination}% Illuminated`;
}

function updateMoonPhase(){
  document.getElementById("funText").innerHTML=getMoonPhase();
  startTileSlider("funSlider",CONFIG.rotateIntervalMs);
}

updateMoonPhase();
setInterval(updateMoonPhase,60*60*1000); // Update every hour

function startTileSlider(sliderId, interval){
  const fill=document.getElementById(sliderId);
  fill.style.width="0%";
  const start=Date.now();
  const update=setInterval(()=>{
    const elapsed=Date.now()-start;
    const percent=Math.min(100,(elapsed/interval)*100);
    fill.style.width=percent+"%";
    if(percent>=100) clearInterval(update);
  },50);
}

/* ========== BOARD GAME GEEK TOP 10 ========== */
const bggTop10=[
  "1. Brass: Birmingham","2. Ark Nova","3. Pandemic Legacy: Season 1","4. Gloomhaven",
  "5. Dune: Imperium","6. Twilight Imperium 4th","7. Dune: Imperium ‚Äì Uprising",
  "8. War of the Ring 2nd","9. Terraforming Mars","10. Star Wars: Rebellion"
];
document.getElementById("bggList").innerHTML=bggTop10.join("<br>");

/* ========== SPORTS SCORES ========== */
const sportsAPIs={
  NBA:"https://site.api.espn.com/apis/site/v2/sports/basketball/nba/scoreboard",
  NFL:"https://site.api.espn.com/apis/site/v2/sports/football/nfl/scoreboard",
  NHL:"https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard",
  MLB:"https://site.api.espn.com/apis/site/v2/sports/baseball/mlb/scoreboard",
  NCAAF:"https://site.api.espn.com/apis/site/v2/sports/football/college-football/scoreboard",
  NCAAM:"https://site.api.espn.com/apis/site/v2/sports/basketball/mens-college-basketball/scoreboard"
};
let sportsData=[];
let sportsIndex=0;

async function loadSportsScores(){
  sportsData=[];
  const today=new Date();
  const yesterday=new Date(today); yesterday.setDate(yesterday.getDate()-1);
  
  for(const [league,baseUrl] of Object.entries(sportsAPIs)){
    // Today's games
    await fetchSportsDay(league,"Today",baseUrl,formatDate(today));
    // Yesterday's games
    await fetchSportsDay(league,"Yesterday",baseUrl,formatDate(yesterday));
  }
  
  if(sportsData.length===0) sportsData.push("No games found");
  rotateSportsTile();
}

async function fetchSportsDay(league,dayLabel,baseUrl,dateStr){
  try{
    const url=`${baseUrl}?dates=${dateStr}`;
    const res=await fetch(url);
    const data=await res.json();
    
    if(data.events && data.events.length>0){
      let html=`<strong>${league} - ${dayLabel}</strong><br>`;
      data.events.forEach(event=>{
        const comp=event.competitions[0];
        const homeTeam=comp.competitors.find(c=>c.homeAway==="home");
        const awayTeam=comp.competitors.find(c=>c.homeAway==="away");
        const status=comp.status.type.description;
        const gameTime=comp.status.type.state==="pre"?new Date(comp.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):"";
        const timeStr=gameTime?` ${gameTime}`:"";
        html+=`${awayTeam.team.abbreviation} ${awayTeam.score} @ ${homeTeam.team.abbreviation} ${homeTeam.score} (${status}${timeStr})<br>`;
      });
      sportsData.push(html);
    }
  }catch(e){console.log(`Error fetching ${league}:`,e);}
}

function formatDate(date){
  const y=date.getFullYear();
  const m=String(date.getMonth()+1).padStart(2,'0');
  const d=String(date.getDate()).padStart(2,'0');
  return `${y}${m}${d}`;
}

function rotateSportsTile(){
  if(sportsData.length===0) return;
  document.getElementById("sportsContent").innerHTML=sportsData[sportsIndex];
  sportsIndex=(sportsIndex+1)%sportsData.length;
  startTileSlider("sportsSlider",CONFIG.rotateIntervalMs);
}

loadSportsScores();
setInterval(rotateSportsTile,CONFIG.rotateIntervalMs);
setInterval(loadSportsScores,10*60*1000); // Refresh every 10 minutes

</script>
</body>
</html>
