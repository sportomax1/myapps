<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pi Dashboard Refined</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  background:black;
  color:white;
  font-family:Arial,Helvetica,sans-serif;
  height:100vh;
  display:grid;
  grid-template-rows:auto 1fr auto;
  overflow:hidden;
  position:relative;
}
.center{display:flex;justify-content:center;align-items:center;}

/* CLOCK */
#clock{font-size:8vw;font-weight:bold;text-align:center;}
body.pulse #clock{font-size:15vw;transition:font-size 0.3s;}

/* TOP-RIGHT INTERNET SPEED */
#speed{position:absolute;top:1vh;right:1vw;font-size:1.5vw;text-align:right;}

/* MAIN PANELS */
#main{display:grid;grid-template-columns:1fr 1fr;gap:1vw;padding:1vh;height:100%;overflow:hidden;}
.panel{background:#111;padding:1vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;border-radius:0.5vh;overflow:hidden;}

/* WEATHER */
#forecast{display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:0.5vw;width:100%;}
.forecast-tile{background:#222;margin:0.5vw;padding:1vh 1vw;min-width:12vw;flex:0 0 auto;border-radius:0.5vh;display:flex;flex-direction:column;align-items:center;transition:transform 0.5s;}
.forecast-tile img{width:3vw;height:3vw;margin-bottom:0.5vh;}

/* CALENDAR */
#calendar{width:50%;padding:1vh;grid-column:1;display:grid;grid-template-rows:auto auto;justify-items:center;}
.calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0.3vh;}
.calendar-day{opacity:0.6;font-weight:bold;}
.calendar-date{padding:0.5vh 0;border-radius:50%;display:flex;justify-content:center;align-items:center;}
.today{background:white;color:black;font-weight:bold;}

/* ROTATING TILES + COUNTDOWN */
#tiles{display:flex;flex-direction:column;align-items:center;justify-content:center;height:6vh;font-size:1.5vw;margin-top:1vh;}
#tileText{margin-bottom:0.5vh;}
#tileSlider{width:80%;height:0.3vh;background:#555;position:relative;border-radius:0.2vh;}
#tileSliderFill{background:#0f0;height:100%;width:0%;border-radius:0.2vh;transition:width 0.1s linear;}

/* RESPONSIVE */
@media(max-width:1024px){
  #clock{font-size:14vw;}
  body.pulse #clock{font-size:22vw;}
  #forecast{font-size:3vw;}
  #speed{font-size:2.5vw;}
  .forecast-tile img{width:6vw;height:6vw;}
  #tiles{font-size:3vw;}
}
</style>
</head>

<body>

<div id="speed">Testing speed...</div>
<div class="center"><div id="clock">--:--:--</div></div>

<div id="main">
  <div class="panel" id="weatherPanel">
    <div id="weather">Loading weather‚Ä¶</div>
    <div id="forecast">Loading forecast‚Ä¶</div>
  </div>

  <div class="panel" id="calendarPanel">
    <div id="calendar"></div>
    <div id="tiles">
      <div id="tileText">Loading tile‚Ä¶</div>
      <div id="tileSlider"><div id="tileSliderFill"></div></div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const CONFIG={
  location:{lat:39.5186,lon:-104.7614},
  refreshMs:30*60*1000,
  rotateIntervalMs:5000
};

/* ================= CLOCK ================= */
function updateClock(){
  const now=new Date();
  const timeString=now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
  document.getElementById("clock").textContent=timeString;
  if(now.getSeconds()===0){
    document.body.classList.add("pulse");
    setTimeout(()=>document.body.classList.remove("pulse"),1000);
  }
}
setInterval(updateClock,1000);
updateClock();

/* ================= CALENDAR ================= */
function renderCalendar(){
  const now=new Date();
  const year=now.getFullYear(), month=now.getMonth(), today=now.getDate();
  const monthName=now.toLocaleString("default",{month:"long"});
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();

  let html=`<div style="font-size:2vw;text-align:center">${monthName} ${year}</div>`;
  html+=`<div class="calendar-grid">`;
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>html+=`<div class="calendar-day">${d}</div>`);
  for(let i=0;i<firstDay;i++) html+="<div></div>";
  for(let d=1;d<=daysInMonth;d++){
    const cls=d===today?"calendar-date today":"calendar-date";
    html+=`<div class="${cls}">${d}</div>`;
  }
  html+="</div>";
  document.getElementById("calendar").innerHTML=html;
}
renderCalendar();

/* ================= WEATHER ================= */
let forecastData=[];
async function loadWeather(){
  try{
    const {lat,lon}=CONFIG.location;
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,rain_sum,snowfall_sum,windspeed_10m_max,precipitation_probability_max,sunrise,sunset,weathercode`+
      `&current_weather=true&timezone=auto&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;
    const res=await fetch(url); const d=await res.json();

    // Current weather
    const cw=d.current_weather;
    document.getElementById("weather").textContent=`Now: üå°Ô∏è ${Math.round(cw.temperature)}¬∞F üí® ${Math.round(cw.windspeed)} mph`;

    forecastData=d.daily;
    renderForecast();
  }catch{document.getElementById("weather").textContent="Weather unavailable";}
}
loadWeather();
setInterval(loadWeather,CONFIG.refreshMs);

function getWeatherIcon(code){
  if(code===0)return"‚òÄÔ∏è";
  else if(code<=3)return"‚õÖ";
  else if(code>=61 && code<=63)return"üåßÔ∏è";
  else if(code>=71 && code<=73)return"‚ùÑÔ∏è";
  else return"‚òÅÔ∏è";
}

function renderForecast(){
  const container=document.getElementById("forecast");
  container.innerHTML="";
  forecastData.time.forEach((t,i)=>{
    const date=new Date(t);
    const dayName=date.toLocaleDateString([],{weekday:'short'});
    const hi=Math.round(forecastData.temperature_2m_max[i]);
    const lo=Math.round(forecastData.temperature_2m_min[i]);
    const rain=forecastData.rain_sum[i].toFixed(2);
    const snow=forecastData.snowfall_sum[i].toFixed(2);
    const wind=Math.round(forecastData.windspeed_10m_max[i]);
    const pop=forecastData.precipitation_probability_max[i];
    const sunrise=new Date(forecastData.sunrise[i]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const sunset=new Date(forecastData.sunset[i]).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const icon=getWeatherIcon(forecastData.weathercode[i]);

    const tile=document.createElement("div");
    tile.className="forecast-tile";
    tile.innerHTML=`<div>${dayName}</div><div>${icon}</div><div>üå°Ô∏è ${hi}/${lo}¬∞F</div><div>üåßÔ∏è ${rain}</div><div>‚ùÑÔ∏è ${snow}</div><div>üí® ${wind} mph</div><div>‚òî ${pop}%</div><div>üåÖ ${sunrise}</div><div>üåá ${sunset}</div>`;
    container.appendChild(tile);
  });
}

/* ================= INTERNET SPEED ================= */
async function testSpeed(){
  const speedDiv=document.getElementById("speed");
  try{
    const start=performance.now();
    const fileSize=500000;
    const url="https://cors-anywhere.herokuapp.com/https://speed.hetzner.de/100MB.bin";
    const res=await fetch(url,{method:'GET',cache:'no-cache'});
    const data=await res.blob();
    const duration=(performance.now()-start)/1000;
    const bits=fileSize*8;
    const Mbps=(bits/duration/1000000).toFixed(1);
    speedDiv.textContent=`‚¨á ${Mbps} Mbps (approx)`;
  }catch{speedDiv.textContent="Speed test unavailable";}
}
testSpeed();
setInterval(testSpeed,60000);

/* ================= ROTATING TILES + SLIDER ================= */
const topGames=[
  "Brass: Birmingham","Ark Nova","Pandemic Legacy: S1","Gloomhaven",
  "Dune: Imperium","Twilight Imperium 4","Dune: Imperium ‚Äì Uprising",
  "War of the Ring 2nd","Terraforming Mars","Star Wars: Rebellion"
];
let tileIndex=0;
const tileText=document.getElementById("tileText");
const sliderFill=document.getElementById("tileSliderFill");
function rotateTiles(){
  tileText.textContent=topGames[tileIndex];
  tileIndex=(tileIndex+1)%topGames.length;
  sliderFill.style.width="0%";
  const start=Date.now();
  const interval=setInterval(()=>{
    const elapsed=Date.now()-start;
    const percent=Math.min(100,(elapsed/CONFIG.rotateIntervalMs)*100);
    sliderFill.style.width=percent+"%";
    if(percent>=100) clearInterval(interval);
  },50);
}
rotateTiles();
setInterval(rotateTiles,CONFIG.rotateIntervalMs);

/* ================= FUTURE FEATURES ================= */
/*
  - Add rotating forecast tiles if more than screen width
  - Add quotes, AQI, stock tickers as rotating tiles
  - Add day/night background gradients based on sunrise/sunset
  - Optionally show more system info (CPU/RAM/Network)
*/
</script>

</body>
</html>